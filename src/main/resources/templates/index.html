<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="apple-touch-icon" href="/icon.svg">
    <link rel="stylesheet" href="/dialog.css">
    <link rel="stylesheet" href="/syntax-highlight.css">
    <title>BISEN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            color: #2d2d2d;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 0;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            box-shadow: 1px 0 3px rgba(0, 0, 0, 0.05);
        }
        
        .sidebar-header {
            padding: 16px 20px;
            background: #ffffff;
            border-bottom: 1px solid #f3f4f6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .sidebar-header h2 {
            color: #111827;
            font-size: 18px;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        
        .sidebar-header p {
            color: #6b7280;
            font-size: 12px;
            font-weight: 400;
            margin: 0;
        }
        
        .sidebar-content {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            background: #fafbfc;
        }
        
        .saved-request-item {
            padding: 10px 12px;
            margin-bottom: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            background: #ffffff;
            border: 1px solid #f3f4f6;
            position: relative;
        }
        
        .saved-request-item:hover {
            background: #f9fafb;
            border-color: #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transform: translateX(2px);
        }
        
        .saved-request-item:active {
            transform: translateX(2px) scale(0.98);
        }
        
        .saved-request-name {
            font-weight: 500;
            color: #111827;
            font-size: 13px;
            margin-bottom: 6px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .saved-request-method {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            margin-right: 6px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            min-width: 42px;
            justify-content: center;
        }
        
        .method-GET { background: #dcfce7; color: #15803d; }
        .method-POST { background: #dbeafe; color: #1e40af; }
        .method-PUT { background: #fef3c7; color: #b45309; }
        .method-DELETE { background: #fee2e2; color: #b91c1c; }
        .method-PATCH { background: #d1fae5; color: #047857; }
        .method-HEAD { background: #f3f4f6; color: #4b5563; }
        .method-OPTIONS { background: #f3e8ff; color: #7e22ce; }
        
        .saved-request-url {
            color: #6b7280;
            font-size: 10px;
            word-break: break-all;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }
        
        .collection-item {
            margin-bottom: 8px;
        }
        
        .collection-header {
            padding: 12px 14px;
            background: #ffffff;
            color: #111827;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #e5e7eb;
            user-select: none;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }
        
        .collection-header:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .collection-name {
            flex: 1;
            color: #111827;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .collection-toggle {
            font-size: 11px;
            color: #6b7280;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background: #f3f4f6;
        }
        
        .collection-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .collection-requests {
            margin-top: 4px;
            margin-left: 0;
            padding-left: 0;
            border-left: none;
        }
        
        .saved-request-item.nested {
            margin-left: 0;
            margin-top: 2px;
            position: relative;
            cursor: pointer;
            padding: 8px 10px;
            background: #ffffff;
            border: 1px solid #f3f4f6;
        }
        
        .saved-request-item.nested:hover {
            background: #f9fafb;
            border-color: #e5e7eb;
        }
        
        .saved-request-item.nested:hover div[style*="opacity: 0"] {
            opacity: 1 !important;
        }
        
        .saved-request-item.nested:hover .btn-add-to-collection {
            opacity: 1;
        }
        
        .application-item {
            margin-top: 6px;
            margin-left: 8px;
            padding-left: 12px;
            border-left: 2px solid #e5e7eb;
        }
        
        .application-header {
            padding: 8px 10px;
            background: #ffffff;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.15s;
            font-weight: 600;
            font-size: 12px;
            border: 1px solid #f3f4f6;
            margin-bottom: 4px;
        }
        
        .application-header:hover {
            background: #f9fafb;
            border-color: #e5e7eb;
        }
        
        .application-name {
            flex: 1;
            color: #374151;
            font-weight: 600;
            font-size: 12px;
        }
        
        .application-toggle {
            font-size: 10px;
            color: #9ca3af;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }
        
        .application-requests {
            margin-top: 4px;
            margin-left: 0;
            padding-left: 0;
        }
        
        .btn-add-to-collection {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .btn-add-to-collection:hover {
            background: #333;
        }
        
        .empty-collection {
            padding: 8px;
            text-align: center;
        }
        
        .collection-menu {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 1000;
            min-width: 200px;
            display: none;
        }
        
        .collection-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9em;
        }
        
        .collection-menu-item:hover {
            background: #f7fafc;
        }
        
        .collection-menu-item:first-child {
            font-weight: 600;
            color: #667eea;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 4px;
        }
        
        .btn-add-new-request {
            width: 100%;
            padding: 10px 14px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.15);
        }
        
        .btn-add-new-request:hover {
            background: #1d4ed8;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.25);
            transform: translateY(-1px);
        }
        
        .btn-add-new-request:active {
            background: #1e40af;
            transform: translateY(0);
        }
        
        .sidebar-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            background: #ffffff;
            color: #111827;
            transition: all 0.15s;
        }
        
        .sidebar-search:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .sidebar-search::placeholder {
            color: #9ca3af;
        }
        
        .btn-add-new-request span:first-child {
            font-size: 18px;
            font-weight: 300;
        }
        
        .btn-add-new-api {
            width: 100%;
            padding: 12px 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(16, 185, 129, 0.2);
        }
        
        .btn-add-new-api:hover {
            background: #059669;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-add-new-api:active {
            background: #047857;
            transform: translateY(0);
        }
        
        .btn-add-new-api span:first-child {
            font-size: 18px;
            font-weight: 300;
        }
        
        .main-content {
            flex: 1;
            margin-left: 300px;
            padding: 0;
            background: #f5f6f7;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .top-nav {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 14px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-brand .brand-name {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            letter-spacing: -0.5px;
        }
        
        .nav-menu {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .nav-menu-item {
            color: #6b7280;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
        }
        
        .nav-menu-item:hover {
            background: #f3f4f6;
            color: #1a1a1a;
        }
        
        .nav-menu-item.active {
            background: #f3f4f6;
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .nav-icon-btn:hover {
            background: #f3f4f6;
            color: #1a1a1a;
        }
        
        .env-selector {
            padding: 6px 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            color: #1a1a1a;
            font-size: 12px;
            cursor: pointer;
        }
        
        .banner {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 32px 24px;
            margin: -24px -24px 24px -24px;
            border-radius: 0;
        }
        
        .banner-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .banner-brand {
            display: flex;
            align-items: center;
        }
        
        .banner-brand h1 {
            margin: 0;
            font-size: 36px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }
        
        .banner-brand p {
            margin: 6px 0 0 0;
            font-size: 15px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 400;
        }
        
        .banner-version {
            display: flex;
            align-items: center;
        }
        
        .version-badge {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header {
            display: none;
        }
        
        .card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 0;
            margin: 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .request-header {
            padding: 24px 28px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(to bottom, #ffffff, #fafbfc);
        }
        
        .request-title {
            font-size: 22px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }
        
        .request-breadcrumb {
            font-size: 13px;
            color: #6b7280;
            font-weight: 400;
        }
        
        .request-builder {
            padding: 28px;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 40px;
            background: #ffffff;
        }
        
        .method-url-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
        }
        
        .method-select {
            width: 130px;
            padding: 11px 14px;
            background: #ffffff;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            color: #111827;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .method-select:hover {
            border-color: #d1d5db;
        }
        
        .method-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .url-input {
            flex: 1;
            padding: 11px 16px;
            background: #ffffff;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            color: #111827;
            font-size: 13px;
            transition: all 0.2s;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }
        
        .url-input:hover {
            border-color: #d1d5db;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-send {
            padding: 11px 24px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }
        
        .btn-send:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-send:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.2);
        }
        
        .btn-save {
            padding: 11px 20px;
            background: #ffffff;
            color: #374151;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-save:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #111827;
        }
        
        .btn-save:active {
            background: #f3f4f6;
        }
        
        .request-tabs {
            display: flex;
            gap: 2px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 24px;
            background: #f9fafb;
            padding: 4px;
            border-radius: 8px 8px 0 0;
        }
        
        .request-tab {
            padding: 10px 18px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            position: relative;
        }
        
        .request-tab:hover {
            color: #374151;
            background: #f3f4f6;
        }
        
        .request-tab.active {
            color: #2563eb;
            background: #ffffff;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            letter-spacing: -0.1px;
        }
        
        .method-url-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px;
        }
        
        select, input[type="text"], textarea, input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.2s;
            font-family: inherit;
            background: #ffffff;
            color: #111827;
        }
        
        select:hover, input:hover, textarea:hover {
            border-color: #d1d5db;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231a1a1a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            line-height: 1.6;
        }
        
        .body-textarea {
            min-height: 150px;
        }
        
        .headers-container {
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            background: #fafbfc;
        }
        
        .params-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 12px;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: #ffffff;
        }
        
        .params-table th {
            text-align: left;
            padding: 12px 14px;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            background: #f9fafb;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1.5px solid #e5e7eb;
        }
        
        .params-table td {
            padding: 12px 14px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .params-table tr:last-child td {
            border-bottom: none;
        }
        
        .params-table tr:hover {
            background: #fafbfc;
        }
        
        .params-table input {
            width: 100%;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            color: #111827;
            border-radius: 6px;
        }
        
        .params-table input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .header-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .header-row input {
            margin: 0;
            padding: 8px 10px;
        }
        
        .header-row:last-child {
            margin-bottom: 0;
        }
        
        .btn-remove-header {
            padding: 6px 12px;
            background: transparent;
            color: #9ca3af;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-remove-header:hover {
            color: #dc2626;
            background: #fef2f2;
            border-color: #fee2e2;
        }
        
        .btn-add-header {
            padding: 9px 14px;
            background: #ffffff;
            color: #374151;
            border: 1.5px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-add-header:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #111827;
        }
        
        .btn-add-header:active {
            background: #f3f4f6;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
        }
        
        .btn-primary {
            background: #1a1a1a;
            color: white;
            flex: 1;
            border: none;
            border-radius: 4px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .btn-primary:hover {
            background: #333;
        }
        
        .btn-primary:active {
            background: #000;
        }
        
        .btn-secondary {
            background: transparent;
            color: #1a1a1a;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-secondary:hover {
            background: #f5f5f5;
            border-color: #1a1a1a;
        }
        
        .response-section {
            margin-top: 24px;
            animation: fadeIn 0.3s ease-in;
            background: #ffffff;
            border: 1.5px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .response-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .response-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn-copy-response {
            padding: 8px 16px;
            background: #ffffff;
            color: #374151;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-copy-response:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #111827;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .btn-copy-response:active {
            transform: translateY(0);
        }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 0.3px;
            display: inline-flex;
            align-items: center;
        }
        
        .status-2xx {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }
        
        .status-4xx {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .status-5xx {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .status-0 {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fde68a;
        }
        
        .response-time {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            color: #1e40af;
            font-size: 13px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }
        
        .response-time-icon {
            width: 16px;
            height: 16px;
            color: #2563eb;
        }
        
        .response-size {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: #f0fdf4;
            border: 1px solid #dcfce7;
            border-radius: 8px;
            color: #166534;
            font-size: 13px;
            font-weight: 600;
        }
        
        .response-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .response-tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            margin-bottom: -1px;
        }
        
        .response-tab:hover {
            color: #2563eb;
        }
        
        .response-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .response-tab-content {
            display: none;
        }
        
        .response-tab-content.active {
            display: block;
        }
        
        .response-body {
            background: #1a1a1a;
            border: 1px solid #374151;
            border-radius: 6px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.7;
            color: #e5e7eb;
            position: relative;
        }
        
        .response-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .response-body::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .response-body::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        
        .response-body::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        .response-headers-container {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .response-headers-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .response-headers-table th {
            text-align: left;
            padding: 8px 12px;
            background: #f3f4f6;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .response-headers-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #1a1a1a;
        }
        
        .response-headers-table tr:hover {
            background: #f9fafb;
        }
        
        .response-headers-table tr:last-child td {
            border-bottom: none;
        }
        
        .header-key {
            font-weight: 600;
            color: #1a1a1a;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        }
        
        .header-value {
            color: #4b5563;
            word-break: break-all;
        }
        
        .response-header-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .response-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-text {
            font-weight: 600;
            font-size: 13px;
        }
        
        .response-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #6b7280;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 280px;
            right: 0;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #6b7280;
            z-index: 40;
            height: 28px;
        }
        
        .status-bar-left {
            display: flex;
            gap: 16px;
        }
        
        .status-bar-right {
            color: #6b7280;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #2563eb;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 15px;
            color: #374151;
            font-weight: 500;
        }
        
        .loading-dots {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2563eb;
            animation: pulse 1.4s ease-in-out infinite;
        }
        
        .loading-dots:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dots:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        .loading::after {
            content: '';
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        
        .response-headers {
            margin-top: 12px;
            padding: 12px;
            background: #fafafa;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
        }
        
        .empty-sidebar {
            text-align: center;
            padding: 40px 20px;
            color: #8a8a8a;
        }
        
        .empty-sidebar p {
            font-size: 13px;
            line-height: 1.6;
        }
        
        .empty-sidebar p:first-child {
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 6px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Projects & APIs</h2>
            <p>Organize and manage your API requests</p>
        </div>
        
        <div class="sidebar-content">
            <div style="margin-bottom: 16px; display: flex; flex-direction: column; gap: 8px;">
                <button class="btn-add-new-request" onclick="clearForm()" title="Create New Request">
                    <span>+</span>
                    <span>New Request</span>
                </button>
                <button class="btn-add-new-api" onclick="openNewApiModal()" title="Create New API in Application" style="width: 100%; padding: 10px 14px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 1px 2px rgba(16, 185, 129, 0.15);">
                    <span>+</span>
                    <span>New API</span>
                </button>
            </div>
            
            <div style="margin-bottom: 12px;">
                <input type="text" id="sidebarSearch" class="sidebar-search" placeholder="üîç Search projects, apps, APIs..." 
                       onkeyup="filterSidebarRequests()">
            </div>
        
            <!-- Projects with nested applications and APIs -->
            <div id="projects-container">
                <!-- Projects will be loaded dynamically via JavaScript -->
                <div class="empty-sidebar" id="empty-projects-state">
                    <p>No projects yet</p>
                    <p>Create a project from the Projects page</p>
                </div>
            </div>
            
            <!-- Unassigned Requests -->
            <div id="unassigned-requests-container" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                <div class="collection-item">
                    <div class="collection-header" data-project-id="unassigned" style="cursor: pointer;" onclick="toggleProject('unassigned')">
                        <span class="collection-name">üì¶ Unassigned Requests</span>
                        <span class="collection-toggle" id="toggle-unassigned">‚ñº</span>
                    </div>
                    <div class="collection-requests" id="project-unassigned" style="display: block;">
                        <!-- Unassigned requests will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="top-nav">
            <div class="nav-brand">
                <img src="/icon.svg" alt="BISEN" style="width: 28px; height: 28px;">
                <span class="brand-name">BISEN</span>
            </div>
            <div class="nav-menu">
                <a href="/projects" class="nav-menu-item">Projects</a>
                <a href="/" class="nav-menu-item active">Home</a>
                <a href="/saved" class="nav-menu-item">Saved Requests</a>
                <a href="/history" class="nav-menu-item">History</a>
                <a href="/import" class="nav-menu-item">Import Swagger</a>
                <a href="/guide" class="nav-menu-item">Guide</a>
            </div>
            <div class="nav-actions">
                <button class="nav-icon-btn" title="Settings">‚öôÔ∏è</button>
                <select class="env-selector" id="topEnvSelect" onchange="switchTopEnvironment()">
                    <option value="">No Environment</option>
                </select>
                <button class="nav-icon-btn" title="Profile">üë§</button>
            </div>
        </div>
        
        <div class="card">
            <div class="request-header">
                <div class="request-title" id="requestTitle">New Request</div>
                <div class="request-breadcrumb" id="requestBreadcrumb"></div>
            </div>
            
            <div class="request-builder">
                <form id="requestForm">
                    <input type="hidden" id="savedRequestId">
                    
                    <div class="method-url-bar">
                        <select id="method" class="method-select" required>
                            <option th:each="method : ${methods}" th:value="${method}" th:text="${method}"></option>
                        </select>
                        <input type="text" id="url" class="url-input" placeholder="https://api.example.com/users" required>
                        <div class="action-buttons">
                            <button type="submit" class="btn-send">
                                <span>Send</span>
                                <span>‚úàÔ∏è</span>
                            </button>
                            <button type="button" class="btn-save" onclick="saveRequest()">Save</button>
                        </div>
                    </div>
                    
                    <div class="request-tabs">
                        <button type="button" class="request-tab active" onclick="switchTab('params')">Params</button>
                        <button type="button" class="request-tab" onclick="switchTab('authorization')">Authorization</button>
                        <button type="button" class="request-tab" onclick="switchTab('headers')">Headers <span id="headersCount">(0)</span></button>
                        <button type="button" class="request-tab" onclick="switchTab('body')">Body</button>
                        <button type="button" class="request-tab" onclick="switchTab('settings')">Settings</button>
                    </div>
                    
                    <div class="tab-content active" id="tab-params">
                        <table class="params-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox"></th>
                                    <th>KEY</th>
                                    <th>VALUE</th>
                                    <th>DESCRIPTION</th>
                                </tr>
                            </thead>
                            <tbody id="paramsTableBody">
                                <tr>
                                    <td><input type="checkbox" checked></td>
                                    <td><input type="text" placeholder="Key" value="active"></td>
                                    <td><input type="text" placeholder="Value" value="true"></td>
                                    <td><input type="text" placeholder="Description" value="Filter by active status"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" checked></td>
                                    <td><input type="text" placeholder="Key" value="limit"></td>
                                    <td><input type="text" placeholder="Value" value="50"></td>
                                    <td><input type="text" placeholder="Description" value="Pagination limit"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td><input type="text" placeholder="Key"></td>
                                    <td><input type="text" placeholder="Value"></td>
                                    <td><input type="text" placeholder="Description"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="tab-content" id="tab-authorization">
                        <div class="form-group">
                            <label>Authorization Type</label>
                            <select id="authType" onchange="updateAuthType()" class="method-select">
                                <option value="none">No Auth</option>
                                <option value="basic">Basic Auth</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="apikey">API Key</option>
                                <option value="digest">Digest Auth</option>
                            </select>
                            
                            <div id="authBasic" style="display: none; margin-top: 12px;">
                                <input type="text" id="authUsername" placeholder="Username" class="url-input" style="margin-bottom: 8px;">
                                <input type="password" id="authPassword" placeholder="Password" class="url-input">
                            </div>
                            
                            <div id="authBearer" style="display: none; margin-top: 12px;">
                                <input type="text" id="authToken" placeholder="Bearer Token" class="url-input">
                            </div>
                            
                            <div id="authApiKey" style="display: none; margin-top: 12px;">
                                <input type="text" id="authApiKey" placeholder="API Key" class="url-input" style="margin-bottom: 8px;">
                                <input type="text" id="authApiKeyHeader" placeholder="Header Name (e.g., X-API-Key)" value="X-API-Key" class="url-input">
                            </div>
                            
                            <div id="authDigest" style="display: none; margin-top: 12px;">
                                <input type="text" id="authDigestUsername" placeholder="Username" class="url-input" style="margin-bottom: 8px;">
                                <input type="password" id="authDigestPassword" placeholder="Password" class="url-input">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="tab-headers">
                        <div class="form-group">
                            <label>Request Headers</label>
                            <div class="headers-container" id="headersContainer">
                                <div class="header-row">
                                    <input type="text" class="header-key" placeholder="Key" value="Content-Type">
                                    <input type="text" class="header-value" placeholder="Value" value="application/json">
                                    <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="btn-add-header" onclick="addHeaderRow()">+ Add Header</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="tab-body">
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin-bottom: 0;">Request Body</label>
                                <select id="bodyType" onchange="updateBodyType()" class="method-select" style="width: 180px;">
                                    <option value="json">JSON</option>
                                    <option value="xml">XML</option>
                                    <option value="form-data">Form Data</option>
                                    <option value="x-www-form-urlencoded">Form URL Encoded</option>
                                    <option value="text">Text/Plain</option>
                                    <option value="html">HTML</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                            <div style="position: relative;">
                                <textarea id="body" class="body-textarea" placeholder='{"key": "value"}' onkeyup="validateBody()" onblur="formatBodyIfNeeded()"></textarea>
                                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                                    <button type="button" onclick="formatBody()" title="Format JSON/XML" style="padding: 6px 12px; font-size: 11px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; color: #1a1a1a;">Format</button>
                                    <button type="button" onclick="validateBody()" title="Validate JSON" style="padding: 6px 12px; font-size: 11px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; color: #1a1a1a;">Validate</button>
                                </div>
                            </div>
                            <div id="bodyTypeHint" style="margin-top: 6px; font-size: 11px; color: #8a8a8a;"></div>
                            <div id="bodyValidation" style="font-size: 11px; margin-top: 4px;"></div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="tab-settings">
                        <div class="form-group">
                            <label>Request Name (Optional)</label>
                            <input type="text" id="name" placeholder="e.g., Get User Profile">
                        </div>
                        
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label style="margin-bottom: 0; font-weight: 500;">Assign to Project & Application</label>
                                <button type="button" onclick="openProjectAssignmentModal()" style="padding: 6px 12px; font-size: 11px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">+ Assign</button>
                            </div>
                            <div id="projectApplicationAssignment" style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; min-height: 50px; display: flex; align-items: center; justify-content: center;">
                                <div id="noAssignment" style="text-align: center; color: #9ca3af; font-size: 13px;">
                                    <div style="font-size: 24px; margin-bottom: 4px;">üìÅ</div>
                                    <div>Not assigned to any project</div>
                                    <div style="font-size: 11px; margin-top: 4px;">Click "+ Assign" to assign</div>
                                </div>
                                <div id="assignmentInfo" style="display: none; width: 100%;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Project</div>
                                            <div style="font-size: 14px; font-weight: 600; color: #1a1a1a;" id="assignedProjectName">-</div>
                                        </div>
                                        <div style="color: #d1d5db; font-size: 18px;">‚Ä∫</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Application</div>
                                            <div style="font-size: 14px; font-weight: 600; color: #1a1a1a;" id="assignedApplicationName">-<span id="assignedApplicationVersion"></span></div>
                                        </div>
                                        <button type="button" onclick="clearProjectAssignment()" style="padding: 6px 12px; font-size: 11px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="applicationId">
                        </div>
                        
                        <div class="form-group">
                            <label>Request Timeout (ms)</label>
                            <input type="number" id="timeout" placeholder="30000" value="30000" min="1000" max="300000" style="width: 200px;">
                            <span style="font-size: 11px; color: #8a8a8a; margin-left: 8px;">Default: 30000ms (30s)</span>
                        </div>
                        
                        <div class="form-group" id="environmentGroup" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin-bottom: 0;">Environment</label>
                                <span style="font-size: 11px; color: #6b7280;" id="environmentAppInfo"></span>
                            </div>
                            <select id="environmentSelect" onchange="loadEnvironmentVariables()" class="method-select" style="margin-bottom: 12px;">
                                <option value="">No Environment</option>
                            </select>
                            <div id="environmentVariables" style="margin-top: 12px; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; display: none;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #1a1a1a;">Environment Variables:</div>
                                <div id="environmentVariablesList" style="font-family: monospace; font-size: 11px; color: #6b7280;"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Certificate (Optional)</label>
                            <input type="file" id="certificateFile" accept=".p12,.pem,.jks,.pfx" class="url-input" style="margin-bottom: 8px;">
                            <input type="password" id="certificatePassword" placeholder="Certificate Password (if required)" class="url-input" style="margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="ignoreSslErrors" style="width: auto;">
                                <label for="ignoreSslErrors" style="font-size: 12px; margin: 0; font-weight: 500; color: #1a1a1a;">Ignore SSL Certificate Errors</label>
                            </div>
                        </div>
                    </div>
                </form>
            
            <div id="loading" class="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text">Sending request<span class="loading-dots"></span><span class="loading-dots"></span><span class="loading-dots"></span></div>
            </div>
            
            <div id="responseSection" class="response-section" style="display: none;">
                <div class="response-header">
                    <div class="response-header-left">
                        <div class="response-status">
                            <span class="status-text" style="font-size: 14px; color: #6b7280; margin-right: 8px;">Status:</span>
                            <span id="statusBadge" class="status-badge"></span>
                        </div>
                        <span id="responseTime" class="response-time">
                            <svg class="response-time-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="responseTimeValue">0 ms</span>
                        </span>
                        <span id="responseSize" class="response-size">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span id="responseSizeValue">0 KB</span>
                        </span>
                    </div>
                    <div class="response-header-right">
                        <button class="btn-copy-response" onclick="copyResponse()" title="Copy Response">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 6px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy
                        </button>
                    </div>
                </div>
                
                <div class="response-tabs">
                    <button class="response-tab active" onclick="switchResponseTab('body')">Body</button>
                    <button class="response-tab" onclick="switchResponseTab('headers')">Headers</button>
                </div>
                
                <div id="responseBodyTab" class="response-tab-content active">
                    <div class="response-body" id="responseBody"></div>
                </div>
                
                <div id="responseHeadersTab" class="response-tab-content">
                    <div class="response-headers-container" id="responseHeadersContainer">
                        <table class="response-headers-table" id="responseHeadersTable">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Header</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="responseHeadersBody">
                                <tr>
                                    <td colspan="2" style="text-align: center; color: #9ca3af; padding: 20px;">No headers available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-bar-left">
            <span>Ln 1, Col 1</span>
            <span>JSON</span>
            <span>UTF-8</span>
        </div>
        <div class="status-bar-right">
            BISEN v1.2 BETA
        </div>
    </div>
    
    <!-- Project Assignment Modal -->
    <div id="projectAssignmentModal" onclick="if(event.target.id === 'projectAssignmentModal') closeProjectAssignmentModal()" 
         style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
        <div onclick="event.stopPropagation()" 
             style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 22px; font-weight: 600;">Assign to Project & Application</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">Select a project and application for this request</p>
                </div>
                <button onclick="closeProjectAssignmentModal()" 
                        style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
            </div>
            
            <!-- Modal Body -->
            <div style="flex: 1; overflow-y: auto; padding: 24px; background: #f8f9fa;">
                <div id="projectAssignmentList" style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Projects and applications will be loaded here -->
                    <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No projects available</div>
                        <div style="font-size: 13px;">Create a project first from the Projects page</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New API Modal -->
    <div id="newApiModal" onclick="if(event.target.id === 'newApiModal') closeNewApiModal()" 
         style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
        <div onclick="event.stopPropagation()" 
             style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 22px; font-weight: 600;">Create New API</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">Select project, application, and enter API details</p>
                </div>
                <button onclick="closeNewApiModal()" 
                        style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
            </div>
            
            <!-- Modal Body -->
            <div style="flex: 1; overflow-y: auto; padding: 24px; background: #f8f9fa;">
                <form id="newApiForm" onsubmit="saveNewApi(event); return false;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">Select Project</label>
                            <select id="newApiProjectId" onchange="updateNewApiApplications()" required
                                    style="width: 100%; padding: 10px 12px; background: white; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #1a1a1a;">
                                <option value="">-- Select Project --</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">Select Application</label>
                            <select id="newApiApplicationId" required
                                    style="width: 100%; padding: 10px 12px; background: white; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #1a1a1a;">
                                <option value="">-- Select Application --</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">API Name</label>
                            <input type="text" id="newApiName" placeholder="e.g., Get User Profile" required
                                   style="width: 100%; padding: 10px 12px; background: white; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #1a1a1a;">
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">HTTP Method</label>
                            <select id="newApiMethod" required
                                    style="width: 100%; padding: 10px 12px; background: white; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #1a1a1a;">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                                <option value="PATCH">PATCH</option>
                                <option value="HEAD">HEAD</option>
                                <option value="OPTIONS">OPTIONS</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">URL</label>
                            <input type="text" id="newApiUrl" placeholder="https://api.example.com/users" required
                                   style="width: 100%; padding: 10px 12px; background: white; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 14px; color: #1a1a1a;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
                        <button type="button" onclick="closeNewApiModal()" 
                                style="padding: 10px 20px; background: #f3f4f6; color: #1a1a1a; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit" 
                                style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">
                            Create API
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching function
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.request-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const tabContent = document.getElementById('tab-' + tabName);
            const tabButton = Array.from(document.querySelectorAll('.request-tab')).find(btn => 
                btn.textContent.toLowerCase().includes(tabName.toLowerCase())
            );
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }
        
        // Update headers count
        function updateHeadersCount() {
            const count = document.querySelectorAll('#headersContainer .header-row').length;
            const countSpan = document.getElementById('headersCount');
            if (countSpan) {
                countSpan.textContent = '(' + count + ')';
            }
        }
        
        // Define toggleCollection early to make it available for onclick handlers
        function toggleCollection(collectionId) {
            const collectionDiv = document.getElementById('collection-' + collectionId);
            const toggleIcon = document.getElementById('toggle-' + collectionId);
            
            if (!collectionDiv) {
                return;
            }
            
            // Check current state
            const currentDisplay = collectionDiv.style.display || window.getComputedStyle(collectionDiv).display;
            const isHidden = currentDisplay === 'none';
            
            if (isHidden) {
                collectionDiv.style.display = 'block';
                if (toggleIcon) {
                    toggleIcon.textContent = '‚ñº';
                }
            } else {
                collectionDiv.style.display = 'none';
                if (toggleIcon) {
                    toggleIcon.textContent = '‚ñ∂';
                }
            }
        }
        
        // Make function globally available immediately
        window.toggleCollection = toggleCollection;
        
        // Define loadSavedRequestFromSidebar early to make it available for onclick handlers
        async function loadSavedRequestFromSidebar(id) {
            try {
                const response = await fetch('/api/saved/' + id);
                if (response.ok) {
                    const savedRequest = await response.json();
                    
                    // Set form values with null checks
                    const savedRequestIdEl = document.getElementById('savedRequestId');
                    if (savedRequestIdEl) savedRequestIdEl.value = savedRequest.id || '';
                    
                    const nameEl = document.getElementById('name');
                    if (nameEl) nameEl.value = savedRequest.name || '';
                    
                    const methodEl = document.getElementById('method');
                    if (methodEl) methodEl.value = savedRequest.method || 'GET';
                    
                    const urlEl = document.getElementById('url');
                    if (urlEl) urlEl.value = savedRequest.url || '';
                    
                    setHeaders(savedRequest.headers || '');
                    
                    const bodyEl = document.getElementById('body');
                    if (bodyEl) bodyEl.value = savedRequest.body || '';
                    
                    // Update request title
                    updateRequestTitle(savedRequest.name || 'Untitled Request', savedRequest);
                    
                    // Load application if available
                    if (savedRequest.application && savedRequest.application.id) {
                        const applicationSelect = document.getElementById('applicationId');
                        if (applicationSelect) {
                            // Wait for applications to load
                            if (applications.length === 0) {
                                await loadProjectsAndApplications();
                            }
                            applicationSelect.value = savedRequest.application.id;
                            if (typeof updateApplicationInfo === 'function') {
                                updateApplicationInfo();
                            }
                            // Update project assignment display
                            if (savedRequest.application.project) {
                                const assignedProjectName = document.getElementById('assignedProjectName');
                                const assignedApplicationName = document.getElementById('assignedApplicationName');
                                const assignedApplicationVersion = document.getElementById('assignedApplicationVersion');
                                const noAssignment = document.getElementById('noAssignment');
                                const assignmentInfo = document.getElementById('assignmentInfo');
                                
                                if (assignedProjectName) assignedProjectName.textContent = savedRequest.application.project.name || '-';
                                if (assignedApplicationName) assignedApplicationName.textContent = savedRequest.application.name || '-';
                                if (assignedApplicationVersion) {
                                    assignedApplicationVersion.textContent = savedRequest.application.version ? ` (${savedRequest.application.version})` : '';
                                }
                                if (noAssignment) noAssignment.style.display = 'none';
                                if (assignmentInfo) assignmentInfo.style.display = 'block';
                            }
                            
                            // Load environments for this application
                            await loadEnvironmentsForApplication(savedRequest.application.id);
                        }
                    } else {
                        const applicationSelect = document.getElementById('applicationId');
                        if (applicationSelect) {
                            applicationSelect.value = '';
                            if (typeof updateApplicationInfo === 'function') {
                                updateApplicationInfo();
                            }
                        }
                        // Clear project assignment display
                        const noAssignment = document.getElementById('noAssignment');
                        const assignmentInfo = document.getElementById('assignmentInfo');
                        if (noAssignment) noAssignment.style.display = 'block';
                        if (assignmentInfo) assignmentInfo.style.display = 'none';
                    }
                    
                    const timeoutEl = document.getElementById('timeout');
                    if (timeoutEl) timeoutEl.value = '30000';
                    
                    // Detect body type from Content-Type header
                    if (typeof detectBodyTypeFromHeaders === 'function') {
                        detectBodyTypeFromHeaders();
                    }
                } else {
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert('Error loading saved request', 'Error');
                    } else {
                        alert('Error loading saved request');
                    }
                }
            } catch (error) {
                console.error('Error loading saved request:', error);
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert('Error: ' + error.message, 'Error');
                } else {
                    alert('Error: ' + error.message);
                }
            }
        }
        
        // Function to update request title and breadcrumb
        function updateRequestTitle(requestName, savedRequest) {
            const titleEl = document.getElementById('requestTitle');
            const breadcrumbEl = document.getElementById('requestBreadcrumb');
            
            if (titleEl) {
                titleEl.textContent = requestName || 'New Request';
            }
            
            if (breadcrumbEl) {
                let breadcrumb = '';
                
                // Add project/application info if available
                if (savedRequest && savedRequest.application) {
                    const app = savedRequest.application;
                    if (app.project) {
                        breadcrumb = `${app.project.name} > ${app.name}`;
                        if (app.version) {
                            breadcrumb += ` (${app.version})`;
                        }
                    } else if (app.name) {
                        breadcrumb = app.name;
                    }
                }
                
                // Add collection info if available
                if (savedRequest && savedRequest.collection) {
                    if (breadcrumb) {
                        breadcrumb += ' ‚Ä¢ ';
                    }
                    breadcrumb += `Collection: ${savedRequest.collection.name}`;
                }
                
                breadcrumbEl.textContent = breadcrumb;
                breadcrumbEl.style.display = breadcrumb ? 'block' : 'none';
            }
        }
        
        // Make it globally available immediately
        window.loadSavedRequestFromSidebar = loadSavedRequestFromSidebar;
        
        function addHeaderRow() {
            const container = document.getElementById('headersContainer');
            const newRow = document.createElement('div');
            newRow.className = 'header-row';
            newRow.innerHTML = `
                <input type="text" class="header-key" placeholder="Key">
                <input type="text" class="header-value" placeholder="Value">
                <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
            `;
            container.appendChild(newRow);
        }
        
        function removeHeader(button) {
            const container = document.getElementById('headersContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                const row = button.parentElement;
                row.querySelector('.header-key').value = '';
                row.querySelector('.header-value').value = '';
            }
        }
        
        function updateBodyType() {
            const bodyType = document.getElementById('bodyType').value;
            const bodyTextarea = document.getElementById('body');
            const hintDiv = document.getElementById('bodyTypeHint');
            
            // Update Content-Type header automatically
            updateContentTypeHeader(bodyType);
            
            // Update placeholder and hint based on type
            switch(bodyType) {
                case 'json':
                    bodyTextarea.placeholder = '{"key": "value", "name": "BISEN"}';
                    hintDiv.textContent = 'üí° Enter valid JSON format';
                    break;
                case 'xml':
                    bodyTextarea.placeholder = '<?xml version="1.0"?>\n<root>\n  <key>value</key>\n</root>';
                    hintDiv.textContent = 'üí° Enter valid XML format';
                    break;
                case 'form-data':
                    bodyTextarea.placeholder = 'key1=value1\nkey2=value2\nkey3=value3';
                    hintDiv.textContent = 'üí° Enter key=value pairs (one per line)';
                    break;
                case 'x-www-form-urlencoded':
                    bodyTextarea.placeholder = 'key1=value1&key2=value2&key3=value3';
                    hintDiv.textContent = 'üí° Enter URL-encoded form data (key=value&key=value)';
                    break;
                case 'text':
                    bodyTextarea.placeholder = 'Enter plain text here...';
                    hintDiv.textContent = 'üí° Enter plain text content';
                    break;
                case 'html':
                    bodyTextarea.placeholder = '<html><body><h1>Hello</h1></body></html>';
                    hintDiv.textContent = 'üí° Enter HTML content';
                    break;
                case 'none':
                    bodyTextarea.placeholder = '';
                    hintDiv.textContent = 'üí° No body will be sent';
                    bodyTextarea.value = '';
                    break;
                default:
                    bodyTextarea.placeholder = '{"key": "value"}';
                    hintDiv.textContent = '';
            }
        }
        
        function updateContentTypeHeader(bodyType) {
            const contentTypeMap = {
                'json': 'application/json',
                'xml': 'application/xml',
                'form-data': 'multipart/form-data',
                'x-www-form-urlencoded': 'application/x-www-form-urlencoded',
                'text': 'text/plain',
                'html': 'text/html',
                'none': ''
            };
            
            const contentType = contentTypeMap[bodyType] || 'application/json';
            
            // Find or create Content-Type header
            const headerRows = document.querySelectorAll('.header-row');
            let found = false;
            
            headerRows.forEach(row => {
                const keyInput = row.querySelector('.header-key');
                if (keyInput.value.trim().toLowerCase() === 'content-type') {
                    if (bodyType === 'none') {
                        // Remove Content-Type for none
                        if (headerRows.length > 1) {
                            row.remove();
                        } else {
                            keyInput.value = '';
                            row.querySelector('.header-value').value = '';
                        }
                    } else {
                        row.querySelector('.header-value').value = contentType;
                    }
                    found = true;
                }
            });
            
            // If Content-Type not found and not 'none', add it
            if (!found && bodyType !== 'none') {
                const container = document.getElementById('headersContainer');
                const newRow = document.createElement('div');
                newRow.className = 'header-row';
                newRow.innerHTML = `
                    <input type="text" class="header-key" placeholder="Key" value="Content-Type">
                    <input type="text" class="header-value" placeholder="Value" value="${contentType}">
                    <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
                `;
                container.insertBefore(newRow, container.firstChild);
            }
        }
        
        function updateAuthType() {
            const authType = document.getElementById('authType').value;
            
            // Hide all auth sections
            document.getElementById('authBasic').style.display = 'none';
            document.getElementById('authBearer').style.display = 'none';
            document.getElementById('authApiKey').style.display = 'none';
            document.getElementById('authDigest').style.display = 'none';
            
            // Show relevant section
            switch(authType) {
                case 'basic':
                    document.getElementById('authBasic').style.display = 'block';
                    break;
                case 'bearer':
                    document.getElementById('authBearer').style.display = 'block';
                    break;
                case 'apikey':
                    document.getElementById('authApiKey').style.display = 'block';
                    break;
                case 'digest':
                    document.getElementById('authDigest').style.display = 'block';
                    break;
            }
        }
        
        async function getCertificateBase64(fileInput) {
            return new Promise((resolve, reject) => {
                if (!fileInput.files || fileInput.files.length === 0) {
                    resolve(null);
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const base64 = e.target.result.split(',')[1]; // Remove data:application/...;base64, prefix
                    resolve(base64);
                };
                
                reader.onerror = function(e) {
                    reject(e);
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        function getHeaders() {
            const headers = [];
            const rows = document.querySelectorAll('.header-row');
            rows.forEach(row => {
                const key = row.querySelector('.header-key').value.trim();
                const value = row.querySelector('.header-value').value.trim();
                if (key && value) {
                    headers.push(key + ': ' + value);
                }
            });
            return headers.join('\n');
        }
        
        function setHeaders(headersString) {
            const container = document.getElementById('headersContainer');
            container.innerHTML = '';
            
            if (!headersString || headersString.trim() === '') {
                addHeaderRow();
                return;
            }
            
            const lines = headersString.split('\n');
            lines.forEach(line => {
                if (line.includes(':')) {
                    const parts = line.split(':', 2);
                    const key = parts[0].trim();
                    const value = parts[1].trim();
                    if (key) {
                        const newRow = document.createElement('div');
                        newRow.className = 'header-row';
                        newRow.innerHTML = `
                            <input type="text" class="header-key" placeholder="Key" value="${key.replace(/"/g, '&quot;')}">
                            <input type="text" class="header-value" placeholder="Value" value="${value.replace(/"/g, '&quot;')}">
                            <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
                        `;
                        container.appendChild(newRow);
                    }
                }
            });
            
            if (container.children.length === 0) {
                addHeaderRow();
            }
        }
        
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const method = document.getElementById('method').value;
            const url = document.getElementById('url').value;
            const headers = getHeaders();
            const bodyType = document.getElementById('bodyType').value;
            const body = bodyType === 'none' ? '' : document.getElementById('body').value;
            const name = document.getElementById('name').value;
            // Collections are deprecated - removed collectionId reference
            
            // Get authorization data
            const authType = document.getElementById('authType').value;
            const authUsername = document.getElementById('authUsername')?.value || '';
            const authPassword = document.getElementById('authPassword')?.value || '';
            const authToken = document.getElementById('authToken')?.value || '';
            const authApiKey = document.getElementById('authApiKey')?.value || '';
            const authApiKeyHeader = document.getElementById('authApiKeyHeader')?.value || 'X-API-Key';
            const authDigestUsername = document.getElementById('authDigestUsername')?.value || '';
            const authDigestPassword = document.getElementById('authDigestPassword')?.value || '';
            
            // Get certificate data
            let certificateBase64 = null;
            try {
                certificateBase64 = await getCertificateBase64(document.getElementById('certificateFile'));
            } catch (error) {
                await CustomDialog.showAlert('Error reading certificate file: ' + error.message, 'Error');
                return;
            }
            
            const certificatePassword = document.getElementById('certificatePassword')?.value || '';
            const ignoreSslErrors = document.getElementById('ignoreSslErrors')?.checked || false;
            
            // Determine certificate type from filename
            let certificateType = null;
            if (certificateBase64) {
                try {
                    const certFileEl = document.getElementById('certificateFile');
                    if (certFileEl && certFileEl.files && certFileEl.files.length > 0) {
                        const fileName = certFileEl.files[0].name ? certFileEl.files[0].name.toLowerCase() : '';
                        if (fileName.endsWith('.p12') || fileName.endsWith('.pfx')) {
                            certificateType = 'p12';
                        } else if (fileName.endsWith('.pem')) {
                            certificateType = 'pem';
                        } else if (fileName.endsWith('.jks')) {
                            certificateType = 'jks';
                        }
                    }
                } catch (e) {
                    // If certificate type detection fails, continue without it
                }
            }
            
            const environmentId = document.getElementById('environmentSelect')?.value || null;
            const variables = document.getElementById('variables')?.value || '';
            
            const requestDto = {
                method: method,
                url: url,
                headers: headers,
                environmentId: environmentId ? parseInt(environmentId) : null,
                variables: variables,
                body: body,
                name: name,
                collectionId: null, // Collections are deprecated
                authType: authType,
                username: authType === 'basic' ? authUsername : (authType === 'digest' ? authDigestUsername : null),
                password: authType === 'basic' ? authPassword : (authType === 'digest' ? authDigestPassword : null),
                token: authType === 'bearer' ? authToken : null,
                apiKey: authType === 'apikey' ? authApiKey : null,
                apiKeyHeader: authType === 'apikey' ? authApiKeyHeader : null,
                certificateFile: certificateBase64,
                certificatePassword: certificatePassword || null,
                certificateType: certificateType,
                ignoreSslErrors: ignoreSslErrors
            };
            
            const loadingEl = document.getElementById('loading');
            const responseSectionEl = document.getElementById('responseSection');
            
            // Show loading screen
            if (loadingEl) {
                loadingEl.style.display = 'flex';
            }
            if (responseSectionEl) {
                responseSectionEl.style.display = 'none';
            }
            
            // Record start time for accurate timing
            window.requestStartTime = Date.now();
            
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestDto)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data) {
                    displayResponse(data);
                } else {
                    displayError({ message: 'Empty response received' });
                }
            } catch (error) {
                displayError(error);
            } finally {
                // Hide loading screen
                if (loadingEl) {
                    loadingEl.style.display = 'none';
                }
            }
        });
        
        function switchResponseTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.response-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.response-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const tabContent = document.getElementById(`response${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
            const tabButton = event.target;
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }
        
        window.switchResponseTab = switchResponseTab;
        
        function displayResponse(data) {
            if (!data) {
                displayError({ message: 'No response data received' });
                return;
            }
            
            const statusCode = data.statusCode != null ? data.statusCode : 0;
            const statusBadge = document.getElementById('statusBadge');
            const responseTimeValue = document.getElementById('responseTimeValue');
            const responseBody = document.getElementById('responseBody');
            const responseHeadersBody = document.getElementById('responseHeadersBody');
            const responseSection = document.getElementById('responseSection');
            
            if (!statusBadge || !responseTimeValue || !responseBody || !responseSection) {
                console.error('Response elements not found');
                return;
            }
            
            // Format status badge
            let statusText = statusCode.toString();
            if (statusCode >= 200 && statusCode < 300) {
                statusText += ' OK';
                statusBadge.className = 'status-badge status-2xx';
            } else if (statusCode >= 400 && statusCode < 500) {
                statusText += ' Error';
                statusBadge.className = 'status-badge status-4xx';
            } else if (statusCode >= 500) {
                statusText += ' Server Error';
                statusBadge.className = 'status-badge status-5xx';
            } else {
                statusText = statusCode > 0 ? statusText : 'Error';
                statusBadge.className = 'status-badge status-0';
            }
            statusBadge.textContent = statusText;
            
            // Display response time prominently
            const responseTimeMs = data.responseTime != null ? data.responseTime : 0;
            let timeDisplay = '';
            if (responseTimeMs < 1000) {
                timeDisplay = `${responseTimeMs} ms`;
            } else if (responseTimeMs < 60000) {
                timeDisplay = `${(responseTimeMs / 1000).toFixed(2)} s`;
            } else {
                timeDisplay = `${(responseTimeMs / 60000).toFixed(2)} min`;
            }
            responseTimeValue.textContent = timeDisplay;
            
            // Calculate and display response size
            const responseText = data.response != null ? data.response : '';
            const responseSizeBytes = new Blob([responseText]).size;
            let sizeDisplay = '';
            if (responseSizeBytes < 1024) {
                sizeDisplay = `${responseSizeBytes} B`;
            } else if (responseSizeBytes < 1048576) {
                sizeDisplay = `${(responseSizeBytes / 1024).toFixed(2)} KB`;
            } else {
                sizeDisplay = `${(responseSizeBytes / 1048576).toFixed(2)} MB`;
            }
            const responseSizeValue = document.getElementById('responseSizeValue');
            if (responseSizeValue) {
                responseSizeValue.textContent = sizeDisplay;
            }
            
            // Format and display response body
            try {
                if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
                    const json = JSON.parse(responseText);
                    responseBody.textContent = JSON.stringify(json, null, 2);
                } else if (responseText.trim().startsWith('<')) {
                    // XML/HTML response
                    responseBody.textContent = responseText;
                } else {
                    responseBody.textContent = responseText || 'No response body';
                }
            } catch (e) {
                responseBody.textContent = responseText || 'No response body';
            }
            
            // Parse and display headers in table format
            if (data.headers && data.headers.trim && data.headers.trim() !== '') {
                const headersText = data.headers;
                const headersArray = headersText.split('\n').filter(line => line.trim() !== '');
                
                if (responseHeadersBody) {
                    responseHeadersBody.innerHTML = '';
                    
                    if (headersArray.length === 0) {
                        responseHeadersBody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #9ca3af; padding: 20px;">No headers available</td></tr>';
                    } else {
                        headersArray.forEach(headerLine => {
                            const colonIndex = headerLine.indexOf(':');
                            if (colonIndex > 0) {
                                const key = headerLine.substring(0, colonIndex).trim();
                                const value = headerLine.substring(colonIndex + 1).trim();
                                
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td class="header-key">${escapeHtml(key)}</td>
                                    <td class="header-value">${escapeHtml(value)}</td>
                                `;
                                responseHeadersBody.appendChild(row);
                            } else {
                                // Handle headers without colon (shouldn't happen, but just in case)
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td class="header-key">${escapeHtml(headerLine)}</td>
                                    <td class="header-value">-</td>
                                `;
                                responseHeadersBody.appendChild(row);
                            }
                        });
                    }
                }
            } else {
                if (responseHeadersBody) {
                    responseHeadersBody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #9ca3af; padding: 20px;">No headers available</td></tr>';
                }
            }
            
            responseSection.style.display = 'block';
        }
        
        function displayError(error) {
            const statusBadge = document.getElementById('statusBadge');
            const responseTimeValue = document.getElementById('responseTimeValue');
            const responseBody = document.getElementById('responseBody');
            const responseSection = document.getElementById('responseSection');
            const responseHeadersBody = document.getElementById('responseHeadersBody');
            
            if (!statusBadge || !responseBody || !responseSection) {
                console.error('Error display elements not found');
                return;
            }
            
            statusBadge.textContent = 'Error';
            statusBadge.className = 'status-badge status-0';
            
            if (responseTimeValue) {
                responseTimeValue.textContent = 'N/A';
            }
            
            const responseSizeValue = document.getElementById('responseSizeValue');
            if (responseSizeValue) {
                responseSizeValue.textContent = 'N/A';
            }
            
            const errorMessage = error && error.message ? error.message : (error ? String(error) : 'Unknown error');
            responseBody.textContent = '// Error\n' + errorMessage;
            
            if (responseHeadersBody) {
                responseHeadersBody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #9ca3af; padding: 20px;">No headers available</td></tr>';
            }
            
            // Switch to body tab
            document.querySelectorAll('.response-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.response-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const bodyTab = document.getElementById('responseBodyTab');
            const bodyTabButton = document.querySelector('.response-tab');
            if (bodyTab) bodyTab.classList.add('active');
            if (bodyTabButton) bodyTabButton.classList.add('active');
            
            responseSection.style.display = 'block';
        }
        
        let environments = [];
        let currentEnvironmentId = null;
        
        // Note: Environment management is now done from the Projects page
        // Environments are application-specific and managed per application
        // All old global environment manager functions have been removed
        
        async function loadEnvironmentsForApplication(applicationId) {
            // Validate applicationId
            if (!applicationId || isNaN(applicationId) || applicationId <= 0) {
                // Hide environment group if no application
                const envGroup = document.getElementById('environmentGroup');
                if (envGroup) envGroup.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/applications/${applicationId}/environments`);
                if (response.ok) {
                    environments = await response.json();
                    const select = document.getElementById('environmentSelect');
                    const envGroup = document.getElementById('environmentGroup');
                    const envAppInfo = document.getElementById('environmentAppInfo');
                    
                    // Show environment group
                    if (envGroup) envGroup.style.display = 'block';
                    
                    // Find application name for info display
                    let appName = 'Application';
                    // Ensure applications is an array before using find
                    if (Array.isArray(applications)) {
                        const app = applications.find(a => a && a.id && (a.id === applicationId || a.id === parseInt(applicationId)));
                        if (app && app.name) {
                            appName = app.name;
                        }
                    }
                    if (envAppInfo) {
                        envAppInfo.textContent = `for ${appName}`;
                    }
                    
                    if (select) {
                        select.innerHTML = '<option value="">No Environment</option>';
                        environments.forEach(env => {
                            const option = document.createElement('option');
                            option.value = env.id;
                            option.textContent = env.name;
                            select.appendChild(option);
                        });
                        
                        // Select first environment by default if available
                        if (environments.length > 0 && !currentEnvironmentId) {
                            select.value = environments[0].id;
                            currentEnvironmentId = environments[0].id;
                            loadEnvironmentVariables();
                        } else if (currentEnvironmentId) {
                            select.value = currentEnvironmentId;
                            loadEnvironmentVariables();
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading environments:', error);
                const envGroup = document.getElementById('environmentGroup');
                if (envGroup) envGroup.style.display = 'none';
            }
        }
        
        async function loadEnvironments() {
            // This function is kept for backward compatibility but now uses application-based loading
            const applicationIdEl = document.getElementById('applicationId');
            const applicationId = applicationIdEl ? applicationIdEl.value : null;
            
            if (applicationId) {
                await loadEnvironmentsForApplication(parseInt(applicationId));
            } else {
                // Hide environment group if no application assigned
                const envGroup = document.getElementById('environmentGroup');
                if (envGroup) envGroup.style.display = 'none';
            }
        }
        
        function switchTopEnvironment() {
            const topSelect = document.getElementById('topEnvSelect');
            const envSelect = document.getElementById('environmentSelect');
            if (topSelect && envSelect) {
                envSelect.value = topSelect.value;
                loadEnvironmentVariables();
            }
        }
        
        async function loadEnvironmentVariables() {
            const envSelect = document.getElementById('environmentSelect');
            const envId = envSelect ? envSelect.value : null;
            const varsContainer = document.getElementById('environmentVariables');
            const varsList = document.getElementById('environmentVariablesList');
            currentEnvironmentId = envId;
            
            // Update top selector too
            const topSelect = document.getElementById('topEnvSelect');
            if (topSelect) {
                topSelect.value = envId || '';
            }
            
            if (!envId || envId === '') {
                if (varsContainer) varsContainer.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch('/api/environments/' + envId);
                if (response.ok) {
                    const env = await response.json();
                    const vars = env.variables ? (typeof env.variables === 'string' ? JSON.parse(env.variables) : env.variables) : {};
                    
                    if (varsContainer) varsContainer.style.display = 'block';
                    if (varsList) {
                        const entries = Object.entries(vars);
                        if (entries.length === 0) {
                            varsList.innerHTML = '<span style="color: #6b7280;">No variables in this environment</span>';
                        } else {
                            varsList.innerHTML = entries.map(([key, value]) => 
                                `<div style="margin-bottom: 4px;"><strong style="color: #1a1a1a;">${escapeHtml(key)}:</strong> <span style="color: #6b7280;">${escapeHtml(value)}</span></div>`
                            ).join('');
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading environment variables:', e);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        
        function toggleVariables() {
            const container = document.getElementById('variablesContainer');
            if (container) {
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function validateVariables() {
            const variablesEl = document.getElementById('variables');
            const validationDiv = document.getElementById('variableValidation');
            if (!variablesEl || !validationDiv) return;
            
            const variablesText = variablesEl.value;
            if (!variablesText || variablesText.trim() === '') {
                validationDiv.innerHTML = '';
                return;
            }
            
            const result = JSONFormatter.validate(variablesText);
            if (result.valid) {
                validationDiv.innerHTML = '<span style="color: #388e3c;">‚úì Valid JSON</span>';
            } else {
                validationDiv.innerHTML = '<span style="color: #d32f2f;">‚úó Invalid JSON: ' + escapeHtml(result.error) + '</span>';
            }
        }
        
        function formatVariables() {
            const variablesEl = document.getElementById('variables');
            if (!variablesEl) return;
            
            const variablesText = variablesEl.value;
            if (!variablesText || variablesText.trim() === '') return;
            
            const formatted = JSONFormatter.format(variablesText);
            variablesEl.value = formatted;
            validateVariables();
        }
        
        function previewVariableSubstitution() {
            const variablesEl = document.getElementById('variables');
            const urlEl = document.getElementById('url');
            const bodyEl = document.getElementById('body');
            const previewDiv = document.getElementById('variablePreview');
            const previewContent = document.getElementById('variablePreviewContent');
            
            if (!variablesEl || !previewDiv || !previewContent) return;
            
            const variablesText = variablesEl.value;
            const url = urlEl ? urlEl.value : '';
            const headers = getHeaders();
            const body = bodyEl ? bodyEl.value : '';
            
            if (!variablesText || variablesText.trim() === '') {
                previewDiv.style.display = 'none';
                return;
            }
            
            try {
                const variables = JSON.parse(variablesText);
                let preview = '';
                
                if (url) {
                    let previewUrl = url;
                    Object.keys(variables).forEach(key => {
                        previewUrl = previewUrl.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), variables[key]);
                    });
                    preview += '<div><strong>URL:</strong> ' + escapeHtml(previewUrl) + '</div>';
                }
                
                if (headers) {
                    let previewHeaders = headers;
                    Object.keys(variables).forEach(key => {
                        previewHeaders = previewHeaders.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), variables[key]);
                    });
                    preview += '<div style="margin-top: 8px;"><strong>Headers:</strong><br><pre style="margin-top: 4px; white-space: pre-wrap;">' + escapeHtml(previewHeaders) + '</pre></div>';
                }
                
                if (body) {
                    let previewBody = body;
                    Object.keys(variables).forEach(key => {
                        previewBody = previewBody.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), variables[key]);
                    });
                    preview += '<div style="margin-top: 8px;"><strong>Body:</strong><br><pre style="margin-top: 4px; white-space: pre-wrap;">' + escapeHtml(previewBody) + '</pre></div>';
                }
                
                if (preview) {
                    previewContent.innerHTML = preview;
                    previewDiv.style.display = 'block';
                } else {
                    previewDiv.style.display = 'none';
                }
            } catch (error) {
                previewContent.innerHTML = '<span style="color: #d32f2f;">Error: Invalid variables JSON</span>';
                previewDiv.style.display = 'block';
            }
        }
        
        function validateBody() {
            const bodyEl = document.getElementById('body');
            const bodyTypeEl = document.getElementById('bodyType');
            const validationDiv = document.getElementById('bodyValidation');
            
            if (!bodyEl || !bodyTypeEl || !validationDiv) return;
            
            const bodyText = bodyEl.value;
            const bodyType = bodyTypeEl.value;
            
            if (!bodyText || bodyText.trim() === '' || bodyType === 'none') {
                validationDiv.innerHTML = '';
                return;
            }
            
            if (bodyType === 'json') {
                const result = JSONFormatter.validate(bodyText);
                if (result.valid) {
                    validationDiv.innerHTML = '<span style="color: #388e3c;">‚úì Valid JSON</span>';
                } else {
                    validationDiv.innerHTML = '<span style="color: #d32f2f;">‚úó Invalid JSON: ' + escapeHtml(result.error) + '</span>';
                }
            } else if (bodyType === 'xml') {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(bodyText, 'text/xml');
                    if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                        validationDiv.innerHTML = '<span style="color: #d32f2f;">‚úó Invalid XML</span>';
                    } else {
                        validationDiv.innerHTML = '<span style="color: #388e3c;">‚úì Valid XML</span>';
                    }
                } catch (error) {
                    validationDiv.innerHTML = '<span style="color: #d32f2f;">‚úó Invalid XML</span>';
                }
            } else {
                validationDiv.innerHTML = '';
            }
        }
        
        function formatBody() {
            const bodyEl = document.getElementById('body');
            const bodyTypeEl = document.getElementById('bodyType');
            
            if (!bodyEl || !bodyTypeEl) return;
            
            const bodyText = bodyEl.value;
            const bodyType = bodyTypeEl.value;
            
            if (!bodyText || bodyText.trim() === '') return;
            
            if (bodyType === 'json') {
                const formatted = JSONFormatter.format(bodyText);
                bodyEl.value = formatted;
                validateBody();
            } else if (bodyType === 'xml') {
                const formatted = JSONFormatter.formatXML(bodyText);
                bodyEl.value = formatted;
                validateBody();
            }
        }
        
        function formatBodyIfNeeded() {
            const bodyEl = document.getElementById('body');
            const bodyTypeEl = document.getElementById('bodyType');
            
            if (!bodyEl || !bodyTypeEl) return;
            
            const bodyText = bodyEl.value;
            const bodyType = bodyTypeEl.value;
            
            if (bodyType === 'json' && bodyText && bodyText.trim()) {
                const result = JSONFormatter.validate(bodyText);
                if (result.valid) {
                    const formatted = JSONFormatter.format(bodyText);
                    if (formatted !== bodyText) {
                        // Auto-format on blur if valid
                        bodyEl.value = formatted;
                    }
                }
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function exportAll() {
            try {
                const response = await fetch('/api/export');
                if (response.ok) {
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'bisen-export-' + new Date().toISOString().split('T')[0] + '.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    await CustomDialog.showAlert('Export successful!', 'Success');
                } else {
                    await CustomDialog.showAlert('Error exporting data', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            }
        }
        
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                const confirmed = await CustomDialog.showConfirm(
                    'This will import all projects, applications, requests, and environments. Continue?',
                    'Import BISEN Format'
                );
                
                if (!confirmed) {
                    event.target.value = '';
                    return;
                }
                
                const response = await fetch('/api/import/bisen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await CustomDialog.showAlert(
                        `Import successful! Created ${result.requestsCreated || 0} requests and ${result.environmentsCreated || 0} environments.`,
                        'Import Success'
                    );
                    location.reload();
                } else {
                    await CustomDialog.showAlert('Error importing data', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            } finally {
                event.target.value = '';
            }
        }
        
        function filterSidebarRequests() {
            const searchTerm = document.getElementById('sidebarSearch').value.toLowerCase();
            const requestItems = document.querySelectorAll('.saved-request-item');
            
            requestItems.forEach(item => {
                const name = item.querySelector('.saved-request-name')?.textContent.toLowerCase() || '';
                const url = item.querySelector('.saved-request-url')?.textContent.toLowerCase() || '';
                const method = item.querySelector('.saved-request-method')?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || url.includes(searchTerm) || method.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Also filter collections
            const collections = document.querySelectorAll('.collection-item');
            collections.forEach(collection => {
                const collectionName = collection.querySelector('.collection-name')?.textContent.toLowerCase() || '';
                const hasVisibleRequests = Array.from(collection.querySelectorAll('.saved-request-item'))
                    .some(item => item.style.display !== 'none');
                
                if (collectionName.includes(searchTerm) || hasVisibleRequests) {
                    collection.style.display = '';
                } else {
                    collection.style.display = 'none';
                }
            });
        }
        
        async function copyResponse() {
            const responseBody = document.getElementById('responseBody');
            const text = responseBody.textContent || responseBody.innerText;
            
            try {
                await navigator.clipboard.writeText(text);
                const btn = document.querySelector('.btn-copy-response');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>Copied!</span>';
                btn.style.background = '#1a1a1a';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'transparent';
                    btn.style.color = '#1a1a1a';
                }, 2000);
            } catch (err) {
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert('Failed to copy: ' + err, 'Error');
                } else {
                    alert('Failed to copy: ' + err);
                }
            }
        }
        
        async function duplicateRequest(requestId) {
            if (!requestId) return;
            
            try {
                // Fetch the original request
                const response = await fetch(`/api/saved/${requestId}`);
                if (!response.ok) {
                    throw new Error('Failed to load request');
                }
                
                const originalRequest = await response.json();
                
                // Create a duplicate request with modified name
                const duplicateName = originalRequest.name ? `${originalRequest.name} (Copy)` : 'Untitled Request (Copy)';
                
                // Prepare the duplicate request data
                const duplicateData = {
                    name: duplicateName,
                    method: originalRequest.method || 'GET',
                    url: originalRequest.url || '',
                    headers: originalRequest.headers || '',
                    body: originalRequest.body || '',
                    applicationId: originalRequest.application ? originalRequest.application.id : null
                };
                
                // Save the duplicate
                const saveResponse = await fetch('/api/saved', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(duplicateData)
                });
                
                if (saveResponse.ok) {
                    const newRequest = await saveResponse.json();
                    
                    // Reload sidebar to show the new duplicate
                    await loadProjectsAndApplications();
                    await loadAllSavedRequests();
                    
                    // Optionally load the duplicate into the form
                    await loadSavedRequestFromSidebar(newRequest.id);
                    
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert(`API request duplicated successfully!`, 'Success');
                    } else {
                        alert('API request duplicated successfully!');
                    }
                } else {
                    const errorText = await saveResponse.text();
                    throw new Error(errorText || 'Failed to create duplicate');
                }
            } catch (error) {
                console.error('Error duplicating request:', error);
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert('Error duplicating request: ' + error.message, 'Error');
                } else {
                    alert('Error duplicating request: ' + error.message);
                }
            }
        }
        
        window.duplicateRequest = duplicateRequest;
        
        function clearForm() {
            document.getElementById('requestForm').reset();
            document.getElementById('savedRequestId').value = '';
            document.getElementById('responseSection').style.display = 'none';
            document.getElementById('bodyType').value = 'json';
            document.getElementById('authType').value = 'none';
            document.getElementById('timeout').value = '30000';
            document.getElementById('variablesContainer').style.display = 'none';
            document.getElementById('variables').value = '';
            document.getElementById('environmentSelect').value = '';
            // Collections are deprecated - no need to clear
            document.getElementById('applicationId').value = '';
            updateBodyType();
            updateAuthType();
            setHeaders('');
            
            // Reset title and breadcrumb
            const titleEl = document.getElementById('requestTitle');
            const breadcrumbEl = document.getElementById('requestBreadcrumb');
            if (titleEl) {
                titleEl.textContent = 'New Request';
            }
            if (breadcrumbEl) {
                breadcrumbEl.textContent = '';
                breadcrumbEl.style.display = 'none';
            }
            
            // Hide application info
            const appInfo = document.getElementById('applicationInfo');
            if (appInfo) {
                appInfo.style.display = 'none';
            }
        }
        
        // Make function globally available
        window.clearForm = clearForm;
        
        function updateBodyType() {
            const bodyType = document.getElementById('bodyType').value;
            const bodyTextarea = document.getElementById('body');
            const hintDiv = document.getElementById('bodyTypeHint');
            
            // Update Content-Type header automatically
            updateContentTypeHeader(bodyType);
            
            // Update placeholder and hint based on type
            switch(bodyType) {
                case 'json':
                    bodyTextarea.placeholder = '{"key": "value", "name": "BISEN"}';
                    hintDiv.textContent = 'üí° Enter valid JSON format';
                    break;
                case 'xml':
                    bodyTextarea.placeholder = '<?xml version="1.0"?>\n<root>\n  <key>value</key>\n</root>';
                    hintDiv.textContent = 'üí° Enter valid XML format';
                    break;
                case 'form-data':
                    bodyTextarea.placeholder = 'key1=value1\nkey2=value2\nkey3=value3';
                    hintDiv.textContent = 'üí° Enter key=value pairs (one per line)';
                    break;
                case 'x-www-form-urlencoded':
                    bodyTextarea.placeholder = 'key1=value1&key2=value2&key3=value3';
                    hintDiv.textContent = 'üí° Enter URL-encoded form data (key=value&key=value)';
                    break;
                case 'text':
                    bodyTextarea.placeholder = 'Enter plain text here...';
                    hintDiv.textContent = 'üí° Enter plain text content';
                    break;
                case 'html':
                    bodyTextarea.placeholder = '<html><body><h1>Hello</h1></body></html>';
                    hintDiv.textContent = 'üí° Enter HTML content';
                    break;
                case 'none':
                    bodyTextarea.placeholder = '';
                    hintDiv.textContent = 'üí° No body will be sent';
                    bodyTextarea.value = '';
                    break;
                default:
                    bodyTextarea.placeholder = '{"key": "value"}';
                    hintDiv.textContent = '';
            }
        }
        
        function updateContentTypeHeader(bodyType) {
            try {
                if (!bodyType || typeof bodyType !== 'string') {
                    return;
                }
                
                const contentTypeMap = {
                    'json': 'application/json',
                    'xml': 'application/xml',
                    'form-data': 'multipart/form-data',
                    'x-www-form-urlencoded': 'application/x-www-form-urlencoded',
                    'text': 'text/plain',
                    'html': 'text/html',
                    'none': ''
                };
                
                const contentType = contentTypeMap[bodyType] || 'application/json';
                
                // Find or create Content-Type header
                const headerRows = document.querySelectorAll('.header-row');
                let found = false;
                
                headerRows.forEach(row => {
                    const keyInput = row.querySelector('.header-key');
                    const valueInput = row.querySelector('.header-value');
                    if (keyInput && valueInput && keyInput.value.trim().toLowerCase() === 'content-type') {
                        if (bodyType === 'none') {
                            // Remove Content-Type for none
                            if (headerRows.length > 1) {
                                row.remove();
                            } else {
                                keyInput.value = '';
                                valueInput.value = '';
                            }
                        } else {
                            valueInput.value = contentType;
                        }
                        found = true;
                    }
                });
                
                // If Content-Type not found and not 'none', add it
                if (!found && bodyType !== 'none') {
                    const container = document.getElementById('headersContainer');
                    if (container) {
                        const newRow = document.createElement('div');
                        newRow.className = 'header-row';
                        newRow.innerHTML = `
                            <input type="text" class="header-key" placeholder="Key" value="Content-Type">
                            <input type="text" class="header-value" placeholder="Value" value="${contentType}">
                            <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
                        `;
                        container.insertBefore(newRow, container.firstChild);
                    }
                }
            } catch (e) {
                console.error('Error updating Content-Type header:', e);
            }
        }
        
        function detectBodyTypeFromHeaders() {
            try {
                const headers = getHeaders();
                if (!headers || typeof headers !== 'string') {
                    return;
                }
                
                const contentTypeMatch = headers.match(/content-type:\s*([^\n]+)/i);
                
                if (contentTypeMatch && contentTypeMatch[1]) {
                    const contentType = contentTypeMatch[1].trim().toLowerCase();
                    let bodyType = 'json'; // default
                    
                    if (contentType.includes('application/json')) {
                        bodyType = 'json';
                    } else if (contentType.includes('application/xml') || contentType.includes('text/xml')) {
                        bodyType = 'xml';
                    } else if (contentType.includes('multipart/form-data')) {
                        bodyType = 'form-data';
                    } else if (contentType.includes('application/x-www-form-urlencoded')) {
                        bodyType = 'x-www-form-urlencoded';
                    } else if (contentType.includes('text/html')) {
                        bodyType = 'html';
                    } else if (contentType.includes('text/plain')) {
                        bodyType = 'text';
                    }
                    
                    const bodyTypeEl = document.getElementById('bodyType');
                    if (bodyTypeEl) {
                        bodyTypeEl.value = bodyType;
                        updateBodyType();
                    }
                }
            } catch (e) {
                console.error('Error detecting body type:', e);
            }
        }
        
        async function saveRequest() {
            const nameEl = document.getElementById('name');
            const methodEl = document.getElementById('method');
            const urlEl = document.getElementById('url');
            const bodyEl = document.getElementById('body');
            const savedRequestIdEl = document.getElementById('savedRequestId');
            
            if (!methodEl || !urlEl) {
                await CustomDialog.showAlert('Form elements not found', 'Error');
                return;
            }
            
            const method = methodEl.value ? methodEl.value.trim() : '';
            const url = urlEl.value ? urlEl.value.trim() : '';
            
            if (!method || !url) {
                await CustomDialog.showAlert('Please fill in Method and URL before saving', 'Validation Error');
                return;
            }
            
            const name = nameEl ? (nameEl.value || '') : '';
            const headers = getHeaders();
            const body = bodyEl ? (bodyEl.value || '') : '';
            const applicationIdEl = document.getElementById('applicationId');
            const applicationId = applicationIdEl ? applicationIdEl.value.trim() : '';
            const savedRequestId = savedRequestIdEl ? savedRequestIdEl.value : '';
            
            console.log('Application ID from form:', applicationId);
            
            let requestName = name;
            if (!requestName) {
                requestName = await CustomDialog.showPrompt('Enter a name for this request:', '', 'Request Name');
                if (!requestName) {
                    return;
                }
                document.getElementById('name').value = requestName;
            }
            
            const savedRequestDto = {
                id: savedRequestId || null,
                name: requestName,
                method: method,
                url: url,
                headers: headers,
                body: body,
                collectionId: null, // Collections are deprecated, use applications instead
                applicationId: applicationId && applicationId !== '' ? parseInt(applicationId) : null
            };
            
            console.log('Saving request with data:', savedRequestDto);
            console.log('Application ID in DTO:', savedRequestDto.applicationId);
            
            try {
                
                const response = await fetch('/api/saved', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(savedRequestDto)
                });
                
                if (response.ok) {
                    const savedRequest = await response.json();
                    console.log('Saved request response:', savedRequest);
                    console.log('Application in response:', savedRequest.application);
                    document.getElementById('savedRequestId').value = savedRequest.id;
                    
                    // Update title after saving
                    updateRequestTitle(requestName, savedRequest);
                    
                    let successMessage = 'Request saved successfully!';
                    if (savedRequest.application) {
                        const app = savedRequest.application;
                        const projectName = app.project ? app.project.name : 'Unknown Project';
                        successMessage = `Request saved successfully and assigned to ${projectName} > ${app.name}!`;
                    } else if (applicationId && applicationId !== '') {
                        const selectedApp = applications.find(app => app.id === parseInt(applicationId));
                        if (selectedApp && selectedApp.project) {
                            successMessage = `Request saved successfully and assigned to ${selectedApp.project.name} > ${selectedApp.name}!`;
                        }
                    }
                    
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert(successMessage, 'Success');
                    } else {
                        alert(successMessage);
                    }
                    
                    // Reload sidebar to show updated hierarchy
                    await loadProjectsAndApplications();
                    await loadAllSavedRequests();
                } else {
                    const errorText = await response.text();
                    console.error('Error saving request:', response.status, errorText);
                    let errorMessage = 'Error saving request';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert(errorMessage, 'Error');
                    } else {
                        alert(errorMessage);
                    }
                }
            } catch (error) {
                console.error('Exception saving request:', error);
                const errorMessage = 'Error: ' + (error.message || 'Unknown error occurred');
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert(errorMessage, 'Error');
                } else {
                    alert(errorMessage);
                }
            }
        }
        
        let currentRequestId = null;
        let collectionMenu = null;
        
        function showAddToCollectionMenu(event, requestId) {
            event.stopPropagation();
            currentRequestId = requestId;
            
            // Remove existing menu if any
            if (collectionMenu) {
                collectionMenu.remove();
            }
            
            // Create menu
            collectionMenu = document.createElement('div');
            collectionMenu.className = 'collection-menu';
            collectionMenu.style.left = event.pageX + 'px';
            collectionMenu.style.top = event.pageY + 'px';
            
            // Add header
            const header = document.createElement('div');
            header.className = 'collection-menu-item';
            header.textContent = 'Add to Collection';
            collectionMenu.appendChild(header);
            
            // Add "Remove from Collection" option
            const removeOption = document.createElement('div');
            removeOption.className = 'collection-menu-item';
            removeOption.textContent = 'Remove from Collection';
            removeOption.onclick = function() {
                addToCollection(null);
            };
            collectionMenu.appendChild(removeOption);
            
            // Add collections from server data or DOM
            if (window.collections && window.collections.length > 0) {
                window.collections.forEach(collection => {
                    const option = document.createElement('div');
                    option.className = 'collection-menu-item';
                    option.textContent = collection.name;
                    option.onclick = function() {
                        addToCollection(collection.id);
                    };
                    collectionMenu.appendChild(option);
                });
            } else {
                // Fallback: extract from DOM
                const collectionItems = document.querySelectorAll('.collection-item');
                collectionItems.forEach(item => {
                    const collectionName = item.querySelector('.collection-name').textContent;
                    const collectionHeader = item.querySelector('.collection-header');
                    const collectionId = collectionHeader.getAttribute('data-collection-id');
                    
                    if (collectionId && collectionName !== 'Unassigned Requests') {
                        const option = document.createElement('div');
                        option.className = 'collection-menu-item';
                        option.textContent = collectionName;
                        option.onclick = function() {
                            addToCollection(parseInt(collectionId));
                        };
                        collectionMenu.appendChild(option);
                    }
                });
            }
            
            // Add click outside to close
            document.body.appendChild(collectionMenu);
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    if (collectionMenu) {
                        collectionMenu.remove();
                        collectionMenu = null;
                    }
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }
        
        async function addToCollection(collectionId) {
            if (!currentRequestId) return;
            
            try {
                const response = await fetch(`/api/saved/${currentRequestId}/collection`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ collectionId: collectionId ? parseInt(collectionId) : null })
                });
                
                if (response.ok) {
                    if (collectionMenu) {
                        collectionMenu.remove();
                        collectionMenu = null;
                    }
                    location.reload();
                } else {
                    await CustomDialog.showAlert('Error updating collection', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            }
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize body type and auth type
            updateBodyType();
            updateAuthType();
            
            // Handle button clicks in sidebar
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.addEventListener('click', function(e) {
                    // Handle duplicate button
                    const duplicateBtn = e.target.closest('button.btn-duplicate');
                    if (duplicateBtn) {
                        e.stopPropagation();
                        const requestId = duplicateBtn.getAttribute('data-request-id');
                        if (requestId) {
                            duplicateRequest(parseInt(requestId));
                        }
                        return false;
                    }
                    
                    // Collections are deprecated - removed add to collection button handler
                });
            }
            
            // Collections are no longer used - using Projects/Applications instead
            
            const loadData = sessionStorage.getItem('loadSavedRequest');
            if (loadData) {
                const saved = JSON.parse(loadData);
                sessionStorage.removeItem('loadSavedRequest');
                
                document.getElementById('savedRequestId').value = saved.id;
                document.getElementById('name').value = saved.name || '';
                document.getElementById('method').value = saved.method;
                document.getElementById('url').value = saved.url;
                setHeaders(saved.headers || '');
                document.getElementById('body').value = saved.body || '';
                // Load application if available
                if (saved.applicationId) {
                    const applicationSelect = document.getElementById('applicationId');
                    if (applicationSelect) {
                        applicationSelect.value = saved.applicationId;
                        updateApplicationInfo();
                    }
                } else {
                    const applicationSelect = document.getElementById('applicationId');
                    if (applicationSelect) {
                        applicationSelect.value = '';
                        updateApplicationInfo();
                    }
                }
                
                // Detect and set body type
                detectBodyTypeFromHeaders();
            }
            // Load environments on page load
            loadEnvironments();
            
            // Load projects and applications
            loadProjectsAndApplications();
            
            // Load all saved requests
            loadAllSavedRequests();
            
            const applicationSelect = document.getElementById('applicationId');
            if (applicationSelect) {
                applicationSelect.addEventListener('change', updateApplicationInfo);
            }
        });
        
        // Load applications on page load
        let projects = [];
        let applications = [];
        
        async function loadProjectsAndApplications() {
            try {
                console.log('Loading projects and applications...');
                const projectsResponse = await fetch('/api/projects');
                if (!projectsResponse.ok) {
                    console.error('Failed to load projects:', projectsResponse.status);
                    return;
                }
                projects = await projectsResponse.json();
                console.log('Loaded projects:', projects.length);
                
                // Load applications for all projects
                applications = [];
                for (const project of projects) {
                    try {
                        const appsResponse = await fetch(`/api/projects/${project.id}/applications`);
                        if (appsResponse.ok) {
                            const projectApps = await appsResponse.json();
                            console.log(`Loaded ${projectApps.length} applications for project ${project.name}`);
                            projectApps.forEach(app => {
                                app.project = project; // Attach project info
                                applications.push(app);
                            });
                        } else {
                            console.warn(`Failed to load applications for project ${project.id}:`, appsResponse.status);
                        }
                    } catch (error) {
                        console.error(`Error loading applications for project ${project.id}:`, error);
                    }
                }
                
                console.log('Total applications loaded:', applications.length);
                updateApplicationSelect();
                // Render sidebar with projects/applications/APIs
                renderSidebarHierarchy();
            } catch (error) {
                console.error('Error loading projects and applications:', error);
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    CustomDialog.showAlert('Error loading projects and applications. Please refresh the page.', 'Error');
                }
            }
        }
        
        // Load all saved requests
        let allSavedRequests = [];
        
        async function loadAllSavedRequests() {
            try {
                const response = await fetch('/api/saved');
                if (response.ok) {
                    allSavedRequests = await response.json();
                    console.log('Loaded saved requests:', allSavedRequests.length);
                    
                    // Update applications array with savedRequests from the loaded requests
                    // This ensures applications show the correct API count
                    applications.forEach(app => {
                        app.savedRequests = allSavedRequests.filter(req => 
                            req.application && req.application.id === app.id
                        );
                    });
                    
                    renderSidebarHierarchy();
                } else {
                    console.error('Failed to load saved requests:', response.status);
                }
            } catch (error) {
                console.error('Error loading saved requests:', error);
            }
        }
        
        // Render Projects > Applications > APIs hierarchy in sidebar
        function renderSidebarHierarchy() {
            const container = document.getElementById('projects-container');
            const emptyState = document.getElementById('empty-projects-state');
            const unassignedContainer = document.getElementById('unassigned-requests-container');
            
            if (!container) return;
            
            // Filter unassigned requests
            const unassignedRequests = allSavedRequests.filter(req => !req.application || !req.application.id);
            
            // Show/hide empty state
            if (projects.length === 0 && unassignedRequests.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                container.innerHTML = '';
            } else {
                if (emptyState) emptyState.style.display = 'none';
                
                let html = '';
                
                // Render each project
                projects.forEach(project => {
                    const projectApps = applications.filter(app => app.project && app.project.id === project.id);
                    
                    html += `
                        <div class="collection-item" data-project-id="${project.id}">
                            <div class="collection-header" 
                                 data-project-id="${project.id}">
                                <div style="flex: 1; display: flex; align-items: center; cursor: pointer;" onclick="toggleProject(${project.id})">
                                    <span class="collection-name">üìÅ ${escapeHtml(project.name)}</span>
                                    <span class="collection-toggle" id="toggle-project-${project.id}">‚ñº</span>
                                </div>
                                <button onclick="event.stopPropagation(); event.preventDefault(); window.location.href='/projects?projectId=${project.id}'; return false;" 
                                        title="Project Settings"
                                        style="background: transparent; border: none; cursor: pointer; color: #6b7280; font-size: 14px; padding: 4px 8px; border-radius: 4px; transition: all 0.15s; z-index: 10; position: relative;"
                                        onmouseover="this.style.background='#f3f4f6'; this.style.color='#2563eb';"
                                        onmouseout="this.style.background='transparent'; this.style.color='#6b7280';">
                                    ‚öôÔ∏è
                                </button>
                            </div>
                            <div class="collection-requests" id="project-${project.id}" style="display: block;">
                                ${projectApps.length === 0 ? `
                                    <div style="padding: 10px 12px; color: #9ca3af; font-size: 11px; font-style: italic; background: #fafbfc; border-radius: 6px; margin-top: 4px;">
                                        No applications yet
                                    </div>
                                ` : projectApps.map(app => {
                                    const appRequests = allSavedRequests.filter(req => 
                                        req.application && req.application.id === app.id
                                    );
                                    
                                    return `
                                        <div class="application-item" data-application-id="${app.id}">
                                            <div class="application-header" 
                                                 data-application-id="${app.id}"
                                                 onclick="toggleApplication(${app.id})">
                                                <span class="application-name">üì± ${escapeHtml(app.name)}${app.version ? ' <span style="color: #9ca3af; font-weight: 400;">v' + escapeHtml(app.version) + '</span>' : ''}</span>
                                                <span class="application-toggle" id="toggle-app-${app.id}">‚ñº</span>
                                            </div>
                                            <div class="application-requests" id="app-${app.id}" style="display: block;">
                                                ${appRequests.length === 0 ? `
                                                    <div style="padding: 8px 10px; color: #9ca3af; font-size: 11px; font-style: italic; background: #fafbfc; border-radius: 4px; margin-top: 2px;">
                                                        No APIs yet
                                                    </div>
                                                ` : appRequests.map(req => `
                                                    <div class="saved-request-item nested" 
                                                         data-request-id="${req.id}"
                                                         onclick="if(!event.target.closest('button')){loadSavedRequestFromSidebar(${req.id});}">
                                                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                                            <span class="saved-request-method method-${req.method}">${escapeHtml(req.method)}</span>
                                                            <div class="saved-request-name" style="flex: 1; margin: 0;">${escapeHtml(req.name || 'Untitled')}</div>
                                                        </div>
                                                        <div class="saved-request-url" style="font-size: 10px; margin-top: 2px;">${escapeHtml(req.url || '')}</div>
                                                        <div style="position: absolute; top: 6px; right: 6px; display: flex; gap: 3px; opacity: 0; transition: opacity 0.15s;">
                                                            <button class="btn-duplicate" 
                                                                    data-request-id="${req.id}"
                                                                    title="Duplicate Request"
                                                                    onclick="event.stopPropagation(); duplicateRequest(${req.id});"
                                                                    style="width: 22px; height: 22px; font-size: 11px; background: #f3f4f6; border: none; cursor: pointer; color: #2563eb; border-radius: 4px; transition: all 0.15s; display: flex; align-items: center; justify-content: center;"
                                                                    onmouseover="this.style.background='#dbeafe'; this.style.color='#1d4ed8'"
                                                                    onmouseout="this.style.background='#f3f4f6'; this.style.color='#2563eb'">üìã</button>
                                                            <button class="btn-delete-request" 
                                                                    data-request-id="${req.id}"
                                                                    title="Delete Request"
                                                                    onclick="event.stopPropagation(); deleteSavedRequest(${req.id});"
                                                                    style="width: 22px; height: 22px; font-size: 11px; background: #fee2e2; border: none; cursor: pointer; color: #dc2626; border-radius: 4px; transition: all 0.15s; display: flex; align-items: center; justify-content: center;"
                                                                    onmouseover="this.style.background='#fecaca'"
                                                                    onmouseout="this.style.background='#fee2e2'">üóëÔ∏è</button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Render unassigned requests
                if (unassignedRequests.length > 0) {
                    if (unassignedContainer) {
                        unassignedContainer.style.display = 'block';
                        const unassignedDiv = unassignedContainer.querySelector('#project-unassigned');
                        if (unassignedDiv) {
                            unassignedDiv.innerHTML = unassignedRequests.map(req => `
                                <div class="saved-request-item nested" 
                                     data-request-id="${req.id}"
                                     onclick="if(!event.target.closest('button')){loadSavedRequestFromSidebar(${req.id});}">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                        <span class="saved-request-method method-${req.method}">${escapeHtml(req.method)}</span>
                                        <div class="saved-request-name" style="flex: 1; margin: 0;">${escapeHtml(req.name || 'Untitled')}</div>
                                    </div>
                                    <div class="saved-request-url" style="font-size: 10px; margin-top: 2px;">${escapeHtml(req.url || '')}</div>
                                    <div style="position: absolute; top: 6px; right: 6px; display: flex; gap: 3px; opacity: 0; transition: opacity 0.15s;">
                                        <button class="btn-duplicate" 
                                                data-request-id="${req.id}"
                                                title="Duplicate Request"
                                                onclick="event.stopPropagation(); duplicateRequest(${req.id});"
                                                style="width: 22px; height: 22px; font-size: 11px; background: #f3f4f6; border: none; cursor: pointer; color: #2563eb; border-radius: 4px; transition: all 0.15s; display: flex; align-items: center; justify-content: center;"
                                                onmouseover="this.style.background='#dbeafe'; this.style.color='#1d4ed8'"
                                                onmouseout="this.style.background='#f3f4f6'; this.style.color='#2563eb'">üìã</button>
                                        <button class="btn-delete-request" 
                                                data-request-id="${req.id}"
                                                title="Delete Request"
                                                onclick="event.stopPropagation(); deleteSavedRequest(${req.id});"
                                                style="width: 22px; height: 22px; font-size: 11px; background: #fee2e2; border: none; cursor: pointer; color: #dc2626; border-radius: 4px; transition: all 0.15s; display: flex; align-items: center; justify-content: center;"
                                                onmouseover="this.style.background='#fecaca'"
                                                onmouseout="this.style.background='#fee2e2'">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('');
                        }
                    }
                } else {
                    if (unassignedContainer) unassignedContainer.style.display = 'none';
                }
            }
        }
        
        // Toggle project expansion
        function toggleProject(projectId) {
            const projectDiv = document.getElementById(`project-${projectId}`);
            const toggle = document.getElementById(`toggle-project-${projectId}`);
            
            if (projectDiv && toggle) {
                if (projectDiv.style.display === 'none') {
                    projectDiv.style.display = 'block';
                    toggle.classList.remove('collapsed');
                    toggle.textContent = '‚ñº';
                } else {
                    projectDiv.style.display = 'none';
                    toggle.classList.add('collapsed');
                    toggle.textContent = '‚ñ∂';
                }
            }
        }
        
        // Toggle application expansion
        function toggleApplication(applicationId) {
            const appDiv = document.getElementById(`app-${applicationId}`);
            const toggle = document.getElementById(`toggle-app-${applicationId}`);
            
            if (appDiv && toggle) {
                if (appDiv.style.display === 'none') {
                    appDiv.style.display = 'block';
                    toggle.classList.remove('collapsed');
                    toggle.textContent = '‚ñº';
                } else {
                    appDiv.style.display = 'none';
                    toggle.classList.add('collapsed');
                    toggle.textContent = '‚ñ∂';
                }
            }
        }
        
        window.toggleProject = toggleProject;
        window.toggleApplication = toggleApplication;
        
        function updateApplicationSelect() {
            const select = document.getElementById('applicationId');
            if (!select) {
                console.warn('Application select element not found');
                return;
            }
            
            select.innerHTML = '<option value="">-- No Application --</option>';
            
            if (applications.length === 0) {
                console.log('No applications available');
                return;
            }
            
            applications.forEach(app => {
                if (!app.id || !app.project || !app.project.name || !app.name) {
                    console.warn('Invalid application data:', app);
                    return;
                }
                
                const option = document.createElement('option');
                option.value = app.id;
                option.textContent = `${app.project.name} > ${app.name}${app.version ? ' (' + app.version + ')' : ''}`;
                option.dataset.projectName = app.project.name;
                option.dataset.appName = app.name;
                select.appendChild(option);
            });
            
            console.log(`Populated application select with ${applications.length} applications`);
        }
        
        async function updateApplicationInfo() {
            const select = document.getElementById('applicationId');
            const infoDiv = document.getElementById('applicationInfo');
            const projectNameSpan = document.getElementById('applicationProjectName');
            const appNameSpan = document.getElementById('applicationName');
            
            if (!select) return;
            
            // Check if there are any options and if a valid option is selected
            if (select.selectedIndex < 0 || select.options.length === 0) {
                if (infoDiv) infoDiv.style.display = 'none';
                const envGroup = document.getElementById('environmentGroup');
                if (envGroup) envGroup.style.display = 'none';
                return;
            }
            
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption) {
                if (infoDiv) infoDiv.style.display = 'none';
                const envGroup = document.getElementById('environmentGroup');
                if (envGroup) envGroup.style.display = 'none';
                return;
            }
            
            const applicationId = selectedOption.value;
            if (!applicationId || applicationId === '' || applicationId === '0') {
                if (infoDiv) infoDiv.style.display = 'none';
                const envGroup = document.getElementById('environmentGroup');
                if (envGroup) envGroup.style.display = 'none';
                return;
            }
            
            const parsedId = parseInt(applicationId);
            if (isNaN(parsedId) || parsedId <= 0) {
                if (infoDiv) infoDiv.style.display = 'none';
                const envGroup = document.getElementById('environmentGroup');
                if (envGroup) envGroup.style.display = 'none';
                return;
            }
            
            // Show application info
            if (infoDiv) infoDiv.style.display = 'block';
            if (projectNameSpan) projectNameSpan.textContent = selectedOption.dataset.projectName || '';
            if (appNameSpan) appNameSpan.textContent = selectedOption.dataset.appName || '';
            
            // Load environments for selected application
            try {
                await loadEnvironmentsForApplication(parsedId);
            } catch (error) {
                console.error('Error loading environments for application:', error);
                // Hide environment group on error
                const envGroup = document.getElementById('environmentGroup');
                if (envGroup) envGroup.style.display = 'none';
            }
        }
        
        window.updateApplicationInfo = updateApplicationInfo;
        
        // Project Assignment Modal Functions
        async function openProjectAssignmentModal() {
            const modal = document.getElementById('projectAssignmentModal');
            if (!modal) {
                console.error('Project assignment modal not found');
                return;
            }
            
            // Ensure projects and applications are loaded
            if (projects.length === 0) {
                await loadProjectsAndApplications();
            }
            
            // Render projects and applications
            renderProjectAssignmentList();
            
            modal.style.display = 'flex';
        }
        
        function closeProjectAssignmentModal() {
            const modal = document.getElementById('projectAssignmentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function renderProjectAssignmentList() {
            const container = document.getElementById('projectAssignmentList');
            if (!container) return;
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No projects available</div>
                        <div style="font-size: 13px;">Create a project first from the <a href="/projects" style="color: #2563eb; text-decoration: none;">Projects page</a></div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            projects.forEach(project => {
                const projectApps = applications.filter(app => app.project && app.project.id === project.id);
                html += `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <div style="padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-size: 16px; font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">${escapeHtml(project.name)}</div>
                            ${project.description ? `<div style="font-size: 12px; color: #6b7280;">${escapeHtml(project.description)}</div>` : ''}
                        </div>
                        <div style="padding: 12px;">
                            ${projectApps.length === 0 ? `
                                <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                                    No applications in this project
                                </div>
                            ` : projectApps.map(app => `
                                <button onclick="selectApplication(${app.id}, '${escapeHtml(project.name)}', '${escapeHtml(app.name)}', '${escapeHtml(app.version || '')}')" 
                                        style="width: 100%; padding: 12px; margin-bottom: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; text-align: left; transition: all 0.2s;"
                                        onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#2563eb'"
                                        onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb'">
                                    <div style="font-size: 14px; font-weight: 500; color: #1a1a1a; margin-bottom: 2px;">${escapeHtml(app.name)}</div>
                                    ${app.version ? `<div style="font-size: 12px; color: #6b7280;">Version: ${escapeHtml(app.version)}</div>` : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function selectApplication(applicationId, projectName, appName, appVersion) {
            const hiddenInput = document.getElementById('applicationId');
            if (hiddenInput) {
                hiddenInput.value = applicationId;
            }
            
            // Update the assignment info display
            const noAssignment = document.getElementById('noAssignment');
            const assignmentInfo = document.getElementById('assignmentInfo');
            const assignedProjectName = document.getElementById('assignedProjectName');
            const assignedApplicationName = document.getElementById('assignedApplicationName');
            const assignedApplicationVersion = document.getElementById('assignedApplicationVersion');
            
            if (noAssignment) noAssignment.style.display = 'none';
            if (assignmentInfo) assignmentInfo.style.display = 'block';
            if (assignedProjectName) assignedProjectName.textContent = projectName;
            if (assignedApplicationName) assignedApplicationName.textContent = appName;
            if (assignedApplicationVersion) {
                assignedApplicationVersion.textContent = appVersion ? ` (${appVersion})` : '';
            }
            
            // Load environments for this application
            await loadEnvironmentsForApplication(parseInt(applicationId));
            
            closeProjectAssignmentModal();
        }
        
        // New API Modal Functions
        async function openNewApiModal() {
            const modal = document.getElementById('newApiModal');
            if (!modal) {
                console.error('New API modal not found');
                return;
            }
            
            // Ensure projects and applications are loaded
            if (projects.length === 0) {
                await loadProjectsAndApplications();
            }
            
            // Populate project dropdown
            const projectSelect = document.getElementById('newApiProjectId');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="">-- Select Project --</option>';
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    projectSelect.appendChild(option);
                });
            }
            
            // Clear application dropdown
            const appSelect = document.getElementById('newApiApplicationId');
            if (appSelect) {
                appSelect.innerHTML = '<option value="">-- Select Application --</option>';
            }
            
            // Reset form
            const form = document.getElementById('newApiForm');
            if (form) {
                form.reset();
            }
            
            modal.style.display = 'flex';
        }
        
        function closeNewApiModal() {
            const modal = document.getElementById('newApiModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function updateNewApiApplications() {
            const projectSelect = document.getElementById('newApiProjectId');
            const appSelect = document.getElementById('newApiApplicationId');
            
            if (!projectSelect || !appSelect) return;
            
            const projectId = parseInt(projectSelect.value);
            appSelect.innerHTML = '<option value="">-- Select Application --</option>';
            
            if (projectId) {
                const projectApps = applications.filter(app => app.project && app.project.id === projectId);
                projectApps.forEach(app => {
                    const option = document.createElement('option');
                    option.value = app.id;
                    option.textContent = `${app.name}${app.version ? ' (' + app.version + ')' : ''}`;
                    appSelect.appendChild(option);
                });
            }
        }
        
        async function saveNewApi(event) {
            event.preventDefault();
            
            const projectId = document.getElementById('newApiProjectId').value;
            const applicationId = document.getElementById('newApiApplicationId').value;
            const name = document.getElementById('newApiName').value.trim();
            const method = document.getElementById('newApiMethod').value;
            const url = document.getElementById('newApiUrl').value.trim();
            
            if (!projectId || !applicationId || !name || !method || !url) {
                if (typeof CustomDialog !== 'undefined') {
                    await CustomDialog.showAlert('Please fill in all fields', 'Validation Error');
                } else {
                    alert('Please fill in all fields');
                }
                return;
            }
            
            const savedRequestDto = {
                name: name,
                method: method,
                url: url,
                headers: '',
                body: '',
                collectionId: null,
                applicationId: parseInt(applicationId)
            };
            
            try {
                const response = await fetch('/api/saved', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(savedRequestDto)
                });
                
                if (response.ok) {
                    const savedRequest = await response.json();
                    closeNewApiModal();
                    
                    // Reload sidebar - need to reload projects/applications first to get updated data
                    await loadProjectsAndApplications();
                    await loadAllSavedRequests();
                    
                    // Load the new request in the main form
                    await loadSavedRequestFromSidebar(savedRequest.id);
                    
                    if (typeof CustomDialog !== 'undefined') {
                        await CustomDialog.showAlert('API created successfully!', 'Success');
                    } else {
                        alert('API created successfully!');
                    }
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to create API');
                }
            } catch (error) {
                console.error('Error creating API:', error);
                if (typeof CustomDialog !== 'undefined') {
                    await CustomDialog.showAlert('Error creating API: ' + error.message, 'Error');
                } else {
                    alert('Error creating API: ' + error.message);
                }
            }
        }
        
        window.openNewApiModal = openNewApiModal;
        window.closeNewApiModal = closeNewApiModal;
        window.updateNewApiApplications = updateNewApiApplications;
        window.saveNewApi = saveNewApi;
        
        // Delete saved request function
        async function deleteSavedRequest(requestId) {
            if (!requestId) return;
            
            let confirmed = false;
            if (typeof CustomDialog !== 'undefined' && CustomDialog.showConfirm) {
                confirmed = await CustomDialog.showConfirm(
                    'Are you sure you want to delete this API request? This action cannot be undone.',
                    'Confirm Delete'
                );
            } else {
                confirmed = confirm('Are you sure you want to delete this API request? This action cannot be undone.');
            }
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/saved/${requestId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Remove from local array
                    allSavedRequests = allSavedRequests.filter(req => req.id !== requestId);
                    
                    // Reload sidebar
                    await loadProjectsAndApplications();
                    await loadAllSavedRequests();
                    
                    // If the deleted request was currently loaded, clear the form
                    const currentRequestId = document.getElementById('savedRequestId')?.value;
                    if (currentRequestId && parseInt(currentRequestId) === requestId) {
                        clearForm();
                    }
                    
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert('API request deleted successfully', 'Success');
                    } else {
                        alert('API request deleted successfully');
                    }
                } else {
                    throw new Error('Failed to delete request');
                }
            } catch (error) {
                console.error('Error deleting request:', error);
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert('Error deleting request: ' + error.message, 'Error');
                } else {
                    alert('Error deleting request: ' + error.message);
                }
            }
        }
        
        window.deleteSavedRequest = deleteSavedRequest;
        
        function clearProjectAssignment() {
            const hiddenInput = document.getElementById('applicationId');
            if (hiddenInput) {
                hiddenInput.value = '';
            }
            
            const noAssignment = document.getElementById('noAssignment');
            const assignmentInfo = document.getElementById('assignmentInfo');
            
            if (noAssignment) noAssignment.style.display = 'block';
            if (assignmentInfo) assignmentInfo.style.display = 'none';
            
            // Hide environment group
            const envGroup = document.getElementById('environmentGroup');
            if (envGroup) envGroup.style.display = 'none';
            
            // Clear environment select
            const envSelect = document.getElementById('environmentSelect');
            if (envSelect) {
                envSelect.innerHTML = '<option value="">No Environment</option>';
                envSelect.value = '';
            }
            currentEnvironmentId = null;
        }
        
        window.openProjectAssignmentModal = openProjectAssignmentModal;
        window.closeProjectAssignmentModal = closeProjectAssignmentModal;
        window.selectApplication = selectApplication;
        window.clearProjectAssignment = clearProjectAssignment;
        
        // Ensure all global functions are available
        if (typeof clearForm === 'function') {
            window.clearForm = clearForm;
        }
        if (typeof saveRequest === 'function') {
            window.saveRequest = saveRequest;
        }
        if (typeof addHeaderRow === 'function') {
            window.addHeaderRow = addHeaderRow;
        }
        if (typeof removeHeader === 'function') {
            window.removeHeader = removeHeader;
        }
        if (typeof validateBody === 'function') {
            window.validateBody = validateBody;
        }
        if (typeof formatBody === 'function') {
            window.formatBody = formatBody;
        }
        if (typeof copyResponse === 'function') {
            window.copyResponse = copyResponse;
        }
        if (typeof loadSavedRequestFromSidebar === 'function') {
            window.loadSavedRequestFromSidebar = loadSavedRequestFromSidebar;
        }
    </script>
    <script src="/dialog.js"></script>
    <script src="/json-formatter.js"></script>
</body>
</html>
