<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="apple-touch-icon" href="/icon.svg">
    <link rel="stylesheet" href="/dialog.css">
    <link rel="stylesheet" href="/syntax-highlight.css">
    <title>BISEN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            color: #2d2d2d;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            padding: 20px;
            overflow-y: auto;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 100;
        }
        
        .sidebar-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .sidebar-header h2 {
            color: #1a1a1a;
            font-size: 14px;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        
        .sidebar-header p {
            color: #6b7280;
            font-size: 12px;
            font-weight: 400;
        }
        
        .saved-request-item {
            padding: 12px;
            margin-bottom: 6px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
            background: transparent;
        }
        
        .saved-request-item:hover {
            background: #f3f4f6;
        }
        
        .saved-request-name {
            font-weight: 500;
            color: #1a1a1a;
            font-size: 13px;
            margin-bottom: 6px;
        }
        
        .saved-request-method {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
            letter-spacing: 0.2px;
        }
        
        .method-GET { background: #e8f5e9; color: #388e3c; }
        .method-POST { background: #e3f2fd; color: #1976d2; }
        .method-PUT { background: #fff3e0; color: #f57c00; }
        .method-DELETE { background: #ffebee; color: #d32f2f; }
        .method-PATCH { background: #e0f2f1; color: #00796b; }
        .method-HEAD { background: #f5f5f5; color: #757575; }
        .method-OPTIONS { background: #f3e5f5; color: #7b1fa2; }
        
        .saved-request-url {
            color: #8a8a8a;
            font-size: 12px;
            word-break: break-all;
            line-height: 1.4;
        }
        
        .collection-item {
            margin-bottom: 10px;
        }
        
        .collection-header {
            padding: 10px 12px;
            background: transparent;
            color: #1a1a1a;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
            font-weight: 500;
            font-size: 13px;
        }
        
        .collection-header:hover {
            background: #f3f4f6;
        }
        
        .collection-name {
            flex: 1;
        }
        
        .collection-toggle {
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        
        .collection-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .collection-requests {
            margin-top: 4px;
            margin-left: 20px;
            padding-left: 0;
            border-left: 1px solid #e5e5e5;
        }
        
        .saved-request-item.nested {
            margin-left: 0;
            position: relative;
            cursor: pointer;
        }
        
        .saved-request-item.nested:hover {
            background: #f3f4f6;
        }
        
        .saved-request-item.nested:hover .btn-add-to-collection {
            opacity: 1;
        }
        
        .btn-add-to-collection {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .btn-add-to-collection:hover {
            background: #333;
        }
        
        .empty-collection {
            padding: 8px;
            text-align: center;
        }
        
        .collection-menu {
            position: fixed;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 1000;
            min-width: 200px;
            display: none;
        }
        
        .collection-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9em;
        }
        
        .collection-menu-item:hover {
            background: #f7fafc;
        }
        
        .collection-menu-item:first-child {
            font-weight: 600;
            color: #667eea;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 4px;
        }
        
        .btn-add-new-request {
            width: 100%;
            padding: 10px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-add-new-request:hover {
            background: #1d4ed8;
        }
        
        .btn-add-new-request:active {
            background: #1e40af;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 0;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .top-nav {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-brand .brand-name {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a1a;
            letter-spacing: -0.5px;
        }
        
        .nav-menu {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .nav-menu-item {
            color: #6b7280;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
        }
        
        .nav-menu-item:hover {
            background: #f3f4f6;
            color: #1a1a1a;
        }
        
        .nav-menu-item.active {
            background: #f3f4f6;
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        
        .nav-icon-btn:hover {
            background: #f3f4f6;
            color: #1a1a1a;
        }
        
        .env-selector {
            padding: 6px 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            color: #1a1a1a;
            font-size: 12px;
            cursor: pointer;
        }
        
        .banner {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: white;
            padding: 32px 24px;
            margin: -24px -24px 24px -24px;
            border-radius: 0;
        }
        
        .banner-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .banner-brand {
            display: flex;
            align-items: center;
        }
        
        .banner-brand h1 {
            margin: 0;
            font-size: 36px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }
        
        .banner-brand p {
            margin: 6px 0 0 0;
            font-size: 15px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 400;
        }
        
        .banner-version {
            display: flex;
            align-items: center;
        }
        
        .version-badge {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header {
            display: none;
        }
        
        .card {
            background: #ffffff;
            border-radius: 0;
            border: 1px solid #e5e7eb;
            padding: 0;
            margin: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .request-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .request-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .request-breadcrumb {
            font-size: 12px;
            color: #6b7280;
        }
        
        .request-builder {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 40px; /* Space for status bar */
        }
        
        .method-url-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            align-items: center;
        }
        
        .method-select {
            width: 120px;
            padding: 10px 12px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            color: #1a1a1a;
            font-size: 13px;
            font-weight: 500;
        }
        
        .url-input {
            flex: 1;
            padding: 10px 16px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            color: #1a1a1a;
            font-size: 13px;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-send {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-send:hover {
            background: #1d4ed8;
        }
        
        .btn-save {
            padding: 10px 16px;
            background: #ffffff;
            color: #1a1a1a;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .btn-save:hover {
            background: #f9fafb;
        }
        
        .request-tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .request-tab {
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }
        
        .request-tab:hover {
            color: #1a1a1a;
        }
        
        .request-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #1a1a1a;
            font-size: 13px;
        }
        
        .method-url-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px;
        }
        
        select, input[type="text"], textarea, input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.15s;
            font-family: inherit;
            background: #ffffff;
            color: #1a1a1a;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
        }
        
        select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231a1a1a' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            line-height: 1.6;
        }
        
        .body-textarea {
            min-height: 150px;
        }
        
        .headers-container {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            background: #f9fafb;
        }
        
        .params-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        
        .params-table th {
            text-align: left;
            padding: 10px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .params-table td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .params-table input {
            width: 100%;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            color: #1a1a1a;
        }
        
        .params-table tr:last-child td {
            border-bottom: none;
        }
        
        .header-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .header-row input {
            margin: 0;
            padding: 8px 10px;
        }
        
        .header-row:last-child {
            margin-bottom: 0;
        }
        
        .btn-remove-header {
            padding: 6px 10px;
            background: transparent;
            color: #8a8a8a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: color 0.15s;
        }
        
        .btn-remove-header:hover {
            color: #1a1a1a;
            background: #f5f5f5;
        }
        
        .btn-add-header {
            padding: 8px 12px;
            background: transparent;
            color: #1a1a1a;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
            transition: all 0.15s;
        }
        
        .btn-add-header:hover {
            background: #f5f5f5;
            border-color: #1a1a1a;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.3px;
        }
        
        .btn-primary {
            background: #1a1a1a;
            color: white;
            flex: 1;
            border: none;
            border-radius: 4px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .btn-primary:hover {
            background: #333;
        }
        
        .btn-primary:active {
            background: #000;
        }
        
        .btn-secondary {
            background: transparent;
            color: #1a1a1a;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .btn-secondary:hover {
            background: #f5f5f5;
            border-color: #1a1a1a;
        }
        
        .response-section {
            margin-top: 24px;
            animation: fadeIn 0.2s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .btn-copy-response {
            padding: 6px 12px;
            background: transparent;
            color: #1a1a1a;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.15s;
        }
        
        .btn-copy-response:hover {
            background: #f5f5f5;
            border-color: #1a1a1a;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
        }
        
        .status-2xx {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-4xx {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .status-5xx {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .status-0 {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .response-time {
            color: #8a8a8a;
            font-size: 12px;
            font-weight: 400;
            margin-left: 12px;
        }
        
        .response-body {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            color: #1a1a1a;
        }
        
        .response-header-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .response-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-text {
            font-weight: 600;
            font-size: 13px;
        }
        
        .response-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #6b7280;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 280px;
            right: 0;
            background: #ffffff;
            border-top: 1px solid #e5e7eb;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #6b7280;
            z-index: 40;
            height: 28px;
        }
        
        .status-bar-left {
            display: flex;
            gap: 16px;
        }
        
        .status-bar-right {
            color: #6b7280;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        
        .response-headers {
            margin-top: 12px;
            padding: 12px;
            background: #fafafa;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
        }
        
        .empty-sidebar {
            text-align: center;
            padding: 40px 20px;
            color: #8a8a8a;
        }
        
        .empty-sidebar p {
            font-size: 13px;
            line-height: 1.6;
        }
        
        .empty-sidebar p:first-child {
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 6px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Projects & APIs</h2>
            <p>Click to load</p>
        </div>
        
        <div style="margin-bottom: 16px;">
            <button class="btn-add-new-request" onclick="clearForm()" title="Create New Request">
                <span>+</span>
                <span>New Request</span>
            </button>
        </div>
        
        <div style="margin-bottom: 12px;">
            <input type="text" id="sidebarSearch" placeholder="Filter projects..." 
                   style="width: 100%; padding: 8px 12px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; color: #1a1a1a;"
                   onkeyup="filterSidebarRequests()">
        </div>
        
        <!-- Projects with nested applications and APIs -->
        <div id="projects-container">
            <!-- Projects will be loaded dynamically via JavaScript -->
            <div class="empty-sidebar" id="empty-projects-state">
                <p>No projects yet</p>
                <p style="font-size: 0.8em; margin-top: 5px;">Create a project from the Projects page</p>
            </div>
        </div>
        
        <!-- Unassigned Requests -->
        <div id="unassigned-requests-container" style="display: none;">
            <div class="collection-item">
                <div class="collection-header" data-project-id="unassigned" style="cursor: pointer;" onclick="toggleProject('unassigned')">
                    <span class="collection-name">Unassigned Requests</span>
                    <span class="collection-toggle" id="toggle-unassigned">‚ñº</span>
                </div>
                <div class="collection-requests" id="project-unassigned" style="display: block;">
                    <!-- Unassigned requests will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="top-nav">
            <div class="nav-brand">
                <img src="/icon.svg" alt="BISEN" style="width: 28px; height: 28px;">
                <span class="brand-name">BISEN</span>
            </div>
            <div class="nav-menu">
                <a href="/projects" class="nav-menu-item">Projects</a>
                <a href="/" class="nav-menu-item active">Home</a>
                <a href="/saved" class="nav-menu-item">Saved Requests</a>
                <a href="/history" class="nav-menu-item">History</a>
                <a href="/environments" class="nav-menu-item">Environments</a>
                <a href="/import" class="nav-menu-item">Import Swagger</a>
                <a href="/guide" class="nav-menu-item">Guide</a>
            </div>
            <div class="nav-actions">
                <button class="nav-icon-btn" title="Settings">‚öôÔ∏è</button>
                <select class="env-selector" id="topEnvSelect" onchange="switchTopEnvironment()">
                    <option value="">No Environment</option>
                </select>
                <button class="nav-icon-btn" title="Profile">üë§</button>
            </div>
        </div>
        
        <div class="card">
            <div class="request-header">
                <div class="request-title" id="requestTitle">New Request</div>
                <div class="request-breadcrumb" id="requestBreadcrumb"></div>
            </div>
            
            <div class="request-builder">
                <form id="requestForm">
                    <input type="hidden" id="savedRequestId">
                    
                    <div class="method-url-bar">
                        <select id="method" class="method-select" required>
                            <option th:each="method : ${methods}" th:value="${method}" th:text="${method}"></option>
                        </select>
                        <input type="text" id="url" class="url-input" placeholder="https://api.example.com/users" required>
                        <div class="action-buttons">
                            <button type="submit" class="btn-send">
                                <span>Send</span>
                                <span>‚úàÔ∏è</span>
                            </button>
                            <button type="button" class="btn-save" onclick="saveRequest()">Save</button>
                        </div>
                    </div>
                    
                    <div class="request-tabs">
                        <button type="button" class="request-tab active" onclick="switchTab('params')">Params</button>
                        <button type="button" class="request-tab" onclick="switchTab('authorization')">Authorization</button>
                        <button type="button" class="request-tab" onclick="switchTab('headers')">Headers <span id="headersCount">(0)</span></button>
                        <button type="button" class="request-tab" onclick="switchTab('body')">Body</button>
                        <button type="button" class="request-tab" onclick="switchTab('settings')">Settings</button>
                    </div>
                    
                    <div class="tab-content active" id="tab-params">
                        <table class="params-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox"></th>
                                    <th>KEY</th>
                                    <th>VALUE</th>
                                    <th>DESCRIPTION</th>
                                </tr>
                            </thead>
                            <tbody id="paramsTableBody">
                                <tr>
                                    <td><input type="checkbox" checked></td>
                                    <td><input type="text" placeholder="Key" value="active"></td>
                                    <td><input type="text" placeholder="Value" value="true"></td>
                                    <td><input type="text" placeholder="Description" value="Filter by active status"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" checked></td>
                                    <td><input type="text" placeholder="Key" value="limit"></td>
                                    <td><input type="text" placeholder="Value" value="50"></td>
                                    <td><input type="text" placeholder="Description" value="Pagination limit"></td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td><input type="text" placeholder="Key"></td>
                                    <td><input type="text" placeholder="Value"></td>
                                    <td><input type="text" placeholder="Description"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="tab-content" id="tab-authorization">
                        <div class="form-group">
                            <label>Authorization Type</label>
                            <select id="authType" onchange="updateAuthType()" class="method-select">
                                <option value="none">No Auth</option>
                                <option value="basic">Basic Auth</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="apikey">API Key</option>
                                <option value="digest">Digest Auth</option>
                            </select>
                            
                            <div id="authBasic" style="display: none; margin-top: 12px;">
                                <input type="text" id="authUsername" placeholder="Username" class="url-input" style="margin-bottom: 8px;">
                                <input type="password" id="authPassword" placeholder="Password" class="url-input">
                            </div>
                            
                            <div id="authBearer" style="display: none; margin-top: 12px;">
                                <input type="text" id="authToken" placeholder="Bearer Token" class="url-input">
                            </div>
                            
                            <div id="authApiKey" style="display: none; margin-top: 12px;">
                                <input type="text" id="authApiKey" placeholder="API Key" class="url-input" style="margin-bottom: 8px;">
                                <input type="text" id="authApiKeyHeader" placeholder="Header Name (e.g., X-API-Key)" value="X-API-Key" class="url-input">
                            </div>
                            
                            <div id="authDigest" style="display: none; margin-top: 12px;">
                                <input type="text" id="authDigestUsername" placeholder="Username" class="url-input" style="margin-bottom: 8px;">
                                <input type="password" id="authDigestPassword" placeholder="Password" class="url-input">
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="tab-headers">
                        <div class="form-group">
                            <label>Request Headers</label>
                            <div class="headers-container" id="headersContainer">
                                <div class="header-row">
                                    <input type="text" class="header-key" placeholder="Key" value="Content-Type">
                                    <input type="text" class="header-value" placeholder="Value" value="application/json">
                                    <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="btn-add-header" onclick="addHeaderRow()">+ Add Header</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="tab-body">
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin-bottom: 0;">Request Body</label>
                                <select id="bodyType" onchange="updateBodyType()" class="method-select" style="width: 180px;">
                                    <option value="json">JSON</option>
                                    <option value="xml">XML</option>
                                    <option value="form-data">Form Data</option>
                                    <option value="x-www-form-urlencoded">Form URL Encoded</option>
                                    <option value="text">Text/Plain</option>
                                    <option value="html">HTML</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                            <div style="position: relative;">
                                <textarea id="body" class="body-textarea" placeholder='{"key": "value"}' onkeyup="validateBody()" onblur="formatBodyIfNeeded()"></textarea>
                                <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                                    <button type="button" onclick="formatBody()" title="Format JSON/XML" style="padding: 6px 12px; font-size: 11px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; color: #1a1a1a;">Format</button>
                                    <button type="button" onclick="validateBody()" title="Validate JSON" style="padding: 6px 12px; font-size: 11px; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; color: #1a1a1a;">Validate</button>
                                </div>
                            </div>
                            <div id="bodyTypeHint" style="margin-top: 6px; font-size: 11px; color: #8a8a8a;"></div>
                            <div id="bodyValidation" style="font-size: 11px; margin-top: 4px;"></div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="tab-settings">
                        <div class="form-group">
                            <label>Request Name (Optional)</label>
                            <input type="text" id="name" placeholder="e.g., Get User Profile">
                        </div>
                        
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <label style="margin-bottom: 0; font-weight: 500;">Assign to Project & Application</label>
                                <button type="button" onclick="openProjectAssignmentModal()" style="padding: 6px 12px; font-size: 11px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">+ Assign</button>
                            </div>
                            <div id="projectApplicationAssignment" style="padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; min-height: 50px; display: flex; align-items: center; justify-content: center;">
                                <div id="noAssignment" style="text-align: center; color: #9ca3af; font-size: 13px;">
                                    <div style="font-size: 24px; margin-bottom: 4px;">üìÅ</div>
                                    <div>Not assigned to any project</div>
                                    <div style="font-size: 11px; margin-top: 4px;">Click "+ Assign" to assign</div>
                                </div>
                                <div id="assignmentInfo" style="display: none; width: 100%;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Project</div>
                                            <div style="font-size: 14px; font-weight: 600; color: #1a1a1a;" id="assignedProjectName">-</div>
                                        </div>
                                        <div style="color: #d1d5db; font-size: 18px;">‚Ä∫</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Application</div>
                                            <div style="font-size: 14px; font-weight: 600; color: #1a1a1a;" id="assignedApplicationName">-<span id="assignedApplicationVersion"></span></div>
                                        </div>
                                        <button type="button" onclick="clearProjectAssignment()" style="padding: 6px 12px; font-size: 11px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="applicationId">
                        </div>
                        
                        <div class="form-group">
                            <label>Request Timeout (ms)</label>
                            <input type="number" id="timeout" placeholder="30000" value="30000" min="1000" max="300000" style="width: 200px;">
                            <span style="font-size: 11px; color: #8a8a8a; margin-left: 8px;">Default: 30000ms (30s)</span>
                        </div>
                        
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin-bottom: 0;">Environment</label>
                                <button type="button" onclick="openEnvironmentManager()" style="padding: 4px 12px; font-size: 11px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer;">Manage Environments</button>
                            </div>
                            <select id="environmentSelect" onchange="loadEnvironmentVariables()" class="method-select" style="margin-bottom: 12px;">
                                <option value="">No Environment</option>
                            </select>
                            <div id="environmentVariables" style="margin-top: 12px; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; display: none;">
                                <div style="font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #1a1a1a;">Environment Variables:</div>
                                <div id="environmentVariablesList" style="font-family: monospace; font-size: 11px; color: #6b7280;"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Certificate (Optional)</label>
                            <input type="file" id="certificateFile" accept=".p12,.pem,.jks,.pfx" class="url-input" style="margin-bottom: 8px;">
                            <input type="password" id="certificatePassword" placeholder="Certificate Password (if required)" class="url-input" style="margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="ignoreSslErrors" style="width: auto;">
                                <label for="ignoreSslErrors" style="font-size: 12px; margin: 0; font-weight: 500; color: #1a1a1a;">Ignore SSL Certificate Errors</label>
                            </div>
                        </div>
                    </div>
                </form>
            
            <div id="responseSection" class="response-section" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                <div class="response-header">
                    <div class="response-header-info">
                        <div class="response-status">
                            <span class="status-text">Response</span>
                            <span id="statusBadge" class="status-badge"></span>
                        </div>
                        <div class="response-meta">
                            <span id="responseTime" class="response-time"></span>
                            <span id="responseSize"></span>
                        </div>
                    </div>
                    <button class="btn-copy-response" onclick="copyResponse()" title="Copy Response" style="background: #ffffff; border: 1px solid #e5e7eb; color: #1a1a1a;">
                        <span>Copy</span>
                    </button>
                </div>
                
                <div id="responseHeaders" class="response-headers" style="display: none; margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 6px; font-family: monospace; font-size: 11px; max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; color: #1a1a1a;"></div>
                
                <div class="response-body" id="responseBody" style="margin-top: 12px;"></div>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                Sending request
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-bar-left">
            <span>Ln 1, Col 1</span>
            <span>JSON</span>
            <span>UTF-8</span>
        </div>
        <div class="status-bar-right">
            BISEN v1.2 BETA
        </div>
    </div>
    
    <!-- Project Assignment Modal -->
    <div id="projectAssignmentModal" onclick="if(event.target.id === 'projectAssignmentModal') closeProjectAssignmentModal()" 
         style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
        <div onclick="event.stopPropagation()" 
             style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 22px; font-weight: 600;">Assign to Project & Application</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">Select a project and application for this request</p>
                </div>
                <button onclick="closeProjectAssignmentModal()" 
                        style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
            </div>
            
            <!-- Modal Body -->
            <div style="flex: 1; overflow-y: auto; padding: 24px; background: #f8f9fa;">
                <div id="projectAssignmentList" style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Projects and applications will be loaded here -->
                    <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No projects available</div>
                        <div style="font-size: 13px;">Create a project first from the Projects page</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Environment Manager Modal - Improved UI -->
    <div id="envManagerModal" onclick="if(event.target.id === 'envManagerModal') closeEnvironmentManager()" 
         style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
        <div onclick="event.stopPropagation()" 
             style="background: white; border-radius: 12px; width: 90%; max-width: 900px; max-height: 85vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
            
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 22px; font-weight: 600;">Environment Manager</h2>
                    <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;">Create and manage environments with variables</p>
                </div>
                <button onclick="closeEnvironmentManager()" 
                        style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;"
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'">√ó</button>
            </div>
            
            <!-- Modal Body -->
            <div style="flex: 1; overflow-y: auto; padding: 24px; background: #f8f9fa;">
                <!-- Add Environment Button -->
                <div style="margin-bottom: 20px;">
                    <button onclick="addNewEnvironment()" 
                            style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: background 0.2s;"
                            onmouseover="this.style.background='#1d4ed8'"
                            onmouseout="this.style.background='#2563eb'">
                        <span style="font-size: 18px;">+</span>
                        <span>Add New Environment</span>
                    </button>
                </div>
                
                <!-- Environments List -->
                <div id="environmentsList" style="display: flex; flex-direction: column; gap: 20px;">
                    <!-- Environments will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching function
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.request-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const tabContent = document.getElementById('tab-' + tabName);
            const tabButton = Array.from(document.querySelectorAll('.request-tab')).find(btn => 
                btn.textContent.toLowerCase().includes(tabName.toLowerCase())
            );
            
            if (tabContent) {
                tabContent.classList.add('active');
            }
            if (tabButton) {
                tabButton.classList.add('active');
            }
        }
        
        // Update headers count
        function updateHeadersCount() {
            const count = document.querySelectorAll('#headersContainer .header-row').length;
            const countSpan = document.getElementById('headersCount');
            if (countSpan) {
                countSpan.textContent = '(' + count + ')';
            }
        }
        
        // Define toggleCollection early to make it available for onclick handlers
        function toggleCollection(collectionId) {
            const collectionDiv = document.getElementById('collection-' + collectionId);
            const toggleIcon = document.getElementById('toggle-' + collectionId);
            
            if (!collectionDiv) {
                return;
            }
            
            // Check current state
            const currentDisplay = collectionDiv.style.display || window.getComputedStyle(collectionDiv).display;
            const isHidden = currentDisplay === 'none';
            
            if (isHidden) {
                collectionDiv.style.display = 'block';
                if (toggleIcon) {
                    toggleIcon.textContent = '‚ñº';
                }
            } else {
                collectionDiv.style.display = 'none';
                if (toggleIcon) {
                    toggleIcon.textContent = '‚ñ∂';
                }
            }
        }
        
        // Make function globally available immediately
        window.toggleCollection = toggleCollection;
        
        // Define loadSavedRequestFromSidebar early to make it available for onclick handlers
        async function loadSavedRequestFromSidebar(id) {
            try {
                const response = await fetch('/api/saved/' + id);
                if (response.ok) {
                    const savedRequest = await response.json();
                    
                    document.getElementById('savedRequestId').value = savedRequest.id;
                    document.getElementById('name').value = savedRequest.name || '';
                    document.getElementById('method').value = savedRequest.method;
                    document.getElementById('url').value = savedRequest.url;
                    setHeaders(savedRequest.headers || '');
                    document.getElementById('body').value = savedRequest.body || '';
                    document.getElementById('collectionId').value = savedRequest.collection ? savedRequest.collection.id : '';
                    
                    // Update request title
                    updateRequestTitle(savedRequest.name || 'Untitled Request', savedRequest);
                    
                    // Load application if available
                    if (savedRequest.application && savedRequest.application.id) {
                        const applicationSelect = document.getElementById('applicationId');
                        if (applicationSelect) {
                            // Wait for applications to load
                            if (applications.length === 0) {
                                await loadProjectsAndApplications();
                            }
                            applicationSelect.value = savedRequest.application.id;
                            if (typeof updateApplicationInfo === 'function') {
                                updateApplicationInfo();
                            }
                        }
                    } else {
                        const applicationSelect = document.getElementById('applicationId');
                        if (applicationSelect) {
                            applicationSelect.value = '';
                            if (typeof updateApplicationInfo === 'function') {
                                updateApplicationInfo();
                            }
                        }
                    }
                    
                    document.getElementById('timeout').value = '30000';
                    
                    // Detect body type from Content-Type header
                    if (typeof detectBodyTypeFromHeaders === 'function') {
                        detectBodyTypeFromHeaders();
                    }
                } else {
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert('Error loading saved request', 'Error');
                    } else {
                        alert('Error loading saved request');
                    }
                }
            } catch (error) {
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert('Error: ' + error.message, 'Error');
                } else {
                    alert('Error: ' + error.message);
                }
            }
        }
        
        // Function to update request title and breadcrumb
        function updateRequestTitle(requestName, savedRequest) {
            const titleEl = document.getElementById('requestTitle');
            const breadcrumbEl = document.getElementById('requestBreadcrumb');
            
            if (titleEl) {
                titleEl.textContent = requestName || 'New Request';
            }
            
            if (breadcrumbEl) {
                let breadcrumb = '';
                
                // Add project/application info if available
                if (savedRequest && savedRequest.application) {
                    const app = savedRequest.application;
                    if (app.project) {
                        breadcrumb = `${app.project.name} > ${app.name}`;
                        if (app.version) {
                            breadcrumb += ` (${app.version})`;
                        }
                    } else if (app.name) {
                        breadcrumb = app.name;
                    }
                }
                
                // Add collection info if available
                if (savedRequest && savedRequest.collection) {
                    if (breadcrumb) {
                        breadcrumb += ' ‚Ä¢ ';
                    }
                    breadcrumb += `Collection: ${savedRequest.collection.name}`;
                }
                
                breadcrumbEl.textContent = breadcrumb;
                breadcrumbEl.style.display = breadcrumb ? 'block' : 'none';
            }
        }
        
        // Make it globally available immediately
        window.loadSavedRequestFromSidebar = loadSavedRequestFromSidebar;
        
        function addHeaderRow() {
            const container = document.getElementById('headersContainer');
            const newRow = document.createElement('div');
            newRow.className = 'header-row';
            newRow.innerHTML = `
                <input type="text" class="header-key" placeholder="Key">
                <input type="text" class="header-value" placeholder="Value">
                <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
            `;
            container.appendChild(newRow);
        }
        
        function removeHeader(button) {
            const container = document.getElementById('headersContainer');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                const row = button.parentElement;
                row.querySelector('.header-key').value = '';
                row.querySelector('.header-value').value = '';
            }
        }
        
        function updateBodyType() {
            const bodyType = document.getElementById('bodyType').value;
            const bodyTextarea = document.getElementById('body');
            const hintDiv = document.getElementById('bodyTypeHint');
            
            // Update Content-Type header automatically
            updateContentTypeHeader(bodyType);
            
            // Update placeholder and hint based on type
            switch(bodyType) {
                case 'json':
                    bodyTextarea.placeholder = '{"key": "value", "name": "BISEN"}';
                    hintDiv.textContent = 'üí° Enter valid JSON format';
                    break;
                case 'xml':
                    bodyTextarea.placeholder = '<?xml version="1.0"?>\n<root>\n  <key>value</key>\n</root>';
                    hintDiv.textContent = 'üí° Enter valid XML format';
                    break;
                case 'form-data':
                    bodyTextarea.placeholder = 'key1=value1\nkey2=value2\nkey3=value3';
                    hintDiv.textContent = 'üí° Enter key=value pairs (one per line)';
                    break;
                case 'x-www-form-urlencoded':
                    bodyTextarea.placeholder = 'key1=value1&key2=value2&key3=value3';
                    hintDiv.textContent = 'üí° Enter URL-encoded form data (key=value&key=value)';
                    break;
                case 'text':
                    bodyTextarea.placeholder = 'Enter plain text here...';
                    hintDiv.textContent = 'üí° Enter plain text content';
                    break;
                case 'html':
                    bodyTextarea.placeholder = '<html><body><h1>Hello</h1></body></html>';
                    hintDiv.textContent = 'üí° Enter HTML content';
                    break;
                case 'none':
                    bodyTextarea.placeholder = '';
                    hintDiv.textContent = 'üí° No body will be sent';
                    bodyTextarea.value = '';
                    break;
                default:
                    bodyTextarea.placeholder = '{"key": "value"}';
                    hintDiv.textContent = '';
            }
        }
        
        function updateContentTypeHeader(bodyType) {
            const contentTypeMap = {
                'json': 'application/json',
                'xml': 'application/xml',
                'form-data': 'multipart/form-data',
                'x-www-form-urlencoded': 'application/x-www-form-urlencoded',
                'text': 'text/plain',
                'html': 'text/html',
                'none': ''
            };
            
            const contentType = contentTypeMap[bodyType] || 'application/json';
            
            // Find or create Content-Type header
            const headerRows = document.querySelectorAll('.header-row');
            let found = false;
            
            headerRows.forEach(row => {
                const keyInput = row.querySelector('.header-key');
                if (keyInput.value.trim().toLowerCase() === 'content-type') {
                    if (bodyType === 'none') {
                        // Remove Content-Type for none
                        if (headerRows.length > 1) {
                            row.remove();
                        } else {
                            keyInput.value = '';
                            row.querySelector('.header-value').value = '';
                        }
                    } else {
                        row.querySelector('.header-value').value = contentType;
                    }
                    found = true;
                }
            });
            
            // If Content-Type not found and not 'none', add it
            if (!found && bodyType !== 'none') {
                const container = document.getElementById('headersContainer');
                const newRow = document.createElement('div');
                newRow.className = 'header-row';
                newRow.innerHTML = `
                    <input type="text" class="header-key" placeholder="Key" value="Content-Type">
                    <input type="text" class="header-value" placeholder="Value" value="${contentType}">
                    <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
                `;
                container.insertBefore(newRow, container.firstChild);
            }
        }
        
        function updateAuthType() {
            const authType = document.getElementById('authType').value;
            
            // Hide all auth sections
            document.getElementById('authBasic').style.display = 'none';
            document.getElementById('authBearer').style.display = 'none';
            document.getElementById('authApiKey').style.display = 'none';
            document.getElementById('authDigest').style.display = 'none';
            
            // Show relevant section
            switch(authType) {
                case 'basic':
                    document.getElementById('authBasic').style.display = 'block';
                    break;
                case 'bearer':
                    document.getElementById('authBearer').style.display = 'block';
                    break;
                case 'apikey':
                    document.getElementById('authApiKey').style.display = 'block';
                    break;
                case 'digest':
                    document.getElementById('authDigest').style.display = 'block';
                    break;
            }
        }
        
        async function getCertificateBase64(fileInput) {
            return new Promise((resolve, reject) => {
                if (!fileInput.files || fileInput.files.length === 0) {
                    resolve(null);
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const base64 = e.target.result.split(',')[1]; // Remove data:application/...;base64, prefix
                    resolve(base64);
                };
                
                reader.onerror = function(e) {
                    reject(e);
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        function getHeaders() {
            const headers = [];
            const rows = document.querySelectorAll('.header-row');
            rows.forEach(row => {
                const key = row.querySelector('.header-key').value.trim();
                const value = row.querySelector('.header-value').value.trim();
                if (key && value) {
                    headers.push(key + ': ' + value);
                }
            });
            return headers.join('\n');
        }
        
        function setHeaders(headersString) {
            const container = document.getElementById('headersContainer');
            container.innerHTML = '';
            
            if (!headersString || headersString.trim() === '') {
                addHeaderRow();
                return;
            }
            
            const lines = headersString.split('\n');
            lines.forEach(line => {
                if (line.includes(':')) {
                    const parts = line.split(':', 2);
                    const key = parts[0].trim();
                    const value = parts[1].trim();
                    if (key) {
                        const newRow = document.createElement('div');
                        newRow.className = 'header-row';
                        newRow.innerHTML = `
                            <input type="text" class="header-key" placeholder="Key" value="${key.replace(/"/g, '&quot;')}">
                            <input type="text" class="header-value" placeholder="Value" value="${value.replace(/"/g, '&quot;')}">
                            <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
                        `;
                        container.appendChild(newRow);
                    }
                }
            });
            
            if (container.children.length === 0) {
                addHeaderRow();
            }
        }
        
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const method = document.getElementById('method').value;
            const url = document.getElementById('url').value;
            const headers = getHeaders();
            const bodyType = document.getElementById('bodyType').value;
            const body = bodyType === 'none' ? '' : document.getElementById('body').value;
            const name = document.getElementById('name').value;
            const collectionId = document.getElementById('collectionId').value;
            
            // Get authorization data
            const authType = document.getElementById('authType').value;
            const authUsername = document.getElementById('authUsername')?.value || '';
            const authPassword = document.getElementById('authPassword')?.value || '';
            const authToken = document.getElementById('authToken')?.value || '';
            const authApiKey = document.getElementById('authApiKey')?.value || '';
            const authApiKeyHeader = document.getElementById('authApiKeyHeader')?.value || 'X-API-Key';
            const authDigestUsername = document.getElementById('authDigestUsername')?.value || '';
            const authDigestPassword = document.getElementById('authDigestPassword')?.value || '';
            
            // Get certificate data
            let certificateBase64 = null;
            try {
                certificateBase64 = await getCertificateBase64(document.getElementById('certificateFile'));
            } catch (error) {
                await CustomDialog.showAlert('Error reading certificate file: ' + error.message, 'Error');
                return;
            }
            
            const certificatePassword = document.getElementById('certificatePassword')?.value || '';
            const ignoreSslErrors = document.getElementById('ignoreSslErrors')?.checked || false;
            
            // Determine certificate type from filename
            let certificateType = null;
            if (certificateBase64) {
                try {
                    const certFileEl = document.getElementById('certificateFile');
                    if (certFileEl && certFileEl.files && certFileEl.files.length > 0) {
                        const fileName = certFileEl.files[0].name ? certFileEl.files[0].name.toLowerCase() : '';
                        if (fileName.endsWith('.p12') || fileName.endsWith('.pfx')) {
                            certificateType = 'p12';
                        } else if (fileName.endsWith('.pem')) {
                            certificateType = 'pem';
                        } else if (fileName.endsWith('.jks')) {
                            certificateType = 'jks';
                        }
                    }
                } catch (e) {
                    // If certificate type detection fails, continue without it
                }
            }
            
            const environmentId = document.getElementById('environmentSelect')?.value || null;
            const variables = document.getElementById('variables')?.value || '';
            
            const requestDto = {
                method: method,
                url: url,
                headers: headers,
                environmentId: environmentId ? parseInt(environmentId) : null,
                variables: variables,
                body: body,
                name: name,
                collectionId: collectionId ? parseInt(collectionId) : null,
                authType: authType,
                username: authType === 'basic' ? authUsername : (authType === 'digest' ? authDigestUsername : null),
                password: authType === 'basic' ? authPassword : (authType === 'digest' ? authDigestPassword : null),
                token: authType === 'bearer' ? authToken : null,
                apiKey: authType === 'apikey' ? authApiKey : null,
                apiKeyHeader: authType === 'apikey' ? authApiKeyHeader : null,
                certificateFile: certificateBase64,
                certificatePassword: certificatePassword || null,
                certificateType: certificateType,
                ignoreSslErrors: ignoreSslErrors
            };
            
            const loadingEl = document.getElementById('loading');
            const responseSectionEl = document.getElementById('responseSection');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (responseSectionEl) responseSectionEl.style.display = 'none';
            
            try {
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestDto)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data) {
                    displayResponse(data);
                } else {
                    displayError({ message: 'Empty response received' });
                }
            } catch (error) {
                displayError(error);
            } finally {
                if (loadingEl) loadingEl.style.display = 'none';
            }
        });
        
        function displayResponse(data) {
            if (!data) {
                displayError({ message: 'No response data received' });
                return;
            }
            
            const statusCode = data.statusCode != null ? data.statusCode : 0;
            const statusBadge = document.getElementById('statusBadge');
            const responseTime = document.getElementById('responseTime');
            const responseBody = document.getElementById('responseBody');
            const responseHeaders = document.getElementById('responseHeaders');
            const responseSection = document.getElementById('responseSection');
            
            if (!statusBadge || !responseTime || !responseBody || !responseSection) {
                console.error('Response elements not found');
                return;
            }
            
            // Format status badge
            let statusText = statusCode.toString();
            if (statusCode >= 200 && statusCode < 300) {
                statusText += ' OK';
                statusBadge.className = 'status-badge status-2xx';
            } else if (statusCode >= 400 && statusCode < 500) {
                statusText += ' Error';
                statusBadge.className = 'status-badge status-4xx';
            } else if (statusCode >= 500) {
                statusText += ' Server Error';
                statusBadge.className = 'status-badge status-5xx';
            } else {
                statusText = statusCode > 0 ? statusText : 'Error';
                statusBadge.className = 'status-badge status-0';
            }
            statusBadge.textContent = statusText;
            
            const responseTimeMs = data.responseTime != null ? data.responseTime : 0;
            responseTime.textContent = `${responseTimeMs} ms`;
            
            // Calculate and display response size
            const responseText = data.response != null ? data.response : '';
            const responseSizeBytes = new Blob([responseText]).size;
            const responseSizeKB = (responseSizeBytes / 1024).toFixed(1);
            const responseSizeEl = document.getElementById('responseSize');
            if (responseSizeEl) {
                responseSizeEl.textContent = `${responseSizeKB} KB`;
            }
            
            try {
                if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
                    const json = JSON.parse(responseText);
                    responseBody.textContent = '// JSON Response\n' + JSON.stringify(json, null, 2);
                } else {
                    responseBody.textContent = responseText || 'No response body';
                }
            } catch (e) {
                responseBody.textContent = responseText || 'No response body';
            }
            
            if (data.headers && data.headers.trim && data.headers.trim() !== '') {
                responseHeaders.textContent = data.headers;
                responseHeaders.style.display = 'block';
            } else {
                responseHeaders.style.display = 'none';
            }
            
            responseSection.style.display = 'block';
        }
        
        function displayError(error) {
            const statusBadge = document.getElementById('statusBadge');
            const responseTime = document.getElementById('responseTime');
            const responseBody = document.getElementById('responseBody');
            const responseSection = document.getElementById('responseSection');
            
            if (!statusBadge || !responseTime || !responseBody || !responseSection) {
                console.error('Error display elements not found');
                return;
            }
            
            statusBadge.textContent = 'Error';
            statusBadge.className = 'status-badge status-0';
            responseTime.textContent = '';
            const responseSizeEl = document.getElementById('responseSize');
            if (responseSizeEl) {
                responseSizeEl.textContent = '';
            }
            
            const errorMessage = error && error.message ? error.message : (error ? String(error) : 'Unknown error');
            responseBody.textContent = 'Error: ' + errorMessage;
            responseSection.style.display = 'block';
        }
        
        let environments = [];
        let currentEnvironmentId = null;
        
        // Environment Manager Functions
        function openEnvironmentManager() {
            const modal = document.getElementById('envManagerModal');
            if (modal) {
                modal.style.display = 'flex';
                loadEnvironmentsForManager();
            }
        }
        
        function closeEnvironmentManager() {
            const modal = document.getElementById('envManagerModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('envManagerModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target.id === 'envManagerModal') {
                        closeEnvironmentManager();
                    }
                });
            }
        });
        
        async function loadEnvironmentsForManager() {
            try {
                const response = await fetch('/api/environments');
                if (response.ok) {
                    environments = await response.json();
                    renderEnvironmentsList();
                }
            } catch (e) {
                console.error('Error loading environments:', e);
            }
        }
        
        function renderEnvironmentsList() {
            const container = document.getElementById('environmentsList');
            if (!container) return;
            
            if (environments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 12px; border: 2px dashed #e5e7eb;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üåç</div>
                        <p style="color: #6b7280; font-size: 16px; margin: 0 0 8px 0; font-weight: 500;">No environments yet</p>
                        <p style="color: #9ca3af; font-size: 14px; margin: 0;">Click "Add New Environment" to create your first environment</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = environments.map(env => {
                const vars = env.variables ? (typeof env.variables === 'string' ? JSON.parse(env.variables) : env.variables) : {};
                const varEntries = Object.entries(vars);
                
                return `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <!-- Environment Header -->
                        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
                                    ${(env.name || 'Env')[0].toUpperCase()}
                                </div>
                                <div style="flex: 1;">
                                    <input type="text" id="env-name-${env.id}" value="${escapeHtml(env.name || '')}" 
                                           placeholder="Environment Name"
                                           style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px; font-weight: 600; width: 100%; max-width: 300px; transition: border-color 0.2s;"
                                           onfocus="this.style.borderColor='#2563eb'; this.style.outline='none'"
                                           onblur="this.style.borderColor='#e5e7eb'; updateEnvironmentName(${env.id})"
                                           onkeypress="if(event.key==='Enter'){this.blur()}">
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                        ${varEntries.length} variable${varEntries.length !== 1 ? 's' : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="saveEnvironment(${env.id})" 
                                        style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: background 0.2s;"
                                        onmouseover="this.style.background='#059669'"
                                        onmouseout="this.style.background='#10b981'">
                                    <span>‚úì</span>
                                    <span>Save</span>
                                </button>
                                <button onclick="deleteEnvironment(${env.id})" 
                                        style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: background 0.2s;"
                                        onmouseover="this.style.background='#dc2626'"
                                        onmouseout="this.style.background='#ef4444'">
                                    <span>üóë</span>
                                    <span>Delete</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Variables Section -->
                        <div style="padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <div style="font-size: 14px; font-weight: 600; color: #1a1a1a;">Variables</div>
                                <button onclick="addEnvVar(${env.id})" 
                                        style="padding: 6px 12px; background: #f3f4f6; color: #2563eb; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; display: flex; align-items: center; gap: 6px; transition: all 0.2s;"
                                        onmouseover="this.style.background='#e5e7eb'; this.style.borderColor='#2563eb'"
                                        onmouseout="this.style.background='#f3f4f6'; this.style.borderColor='#e5e7eb'">
                                    <span>+</span>
                                    <span>Add Variable</span>
                                </button>
                            </div>
                            
                            <div id="env-vars-${env.id}">
                                ${varEntries.length === 0 ? `
                                    <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px; border: 1px dashed #e5e7eb;">
                                        <div style="font-size: 32px; margin-bottom: 8px;">üìù</div>
                                        <p style="color: #6b7280; font-size: 13px; margin: 0;">No variables yet. Click "Add Variable" to add one.</p>
                                    </div>
                                ` : `
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        ${varEntries.map(([key, value], idx) => `
                                            <div style="display: flex; gap: 10px; align-items: center; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; transition: all 0.2s;"
                                                 onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#d1d5db'"
                                                 onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb'">
                                                <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
                                                    <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Key</label>
                                                    <input type="text" value="${escapeHtml(key)}" placeholder="Variable name" 
                                                           style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: 'SF Mono', monospace; background: white; transition: border-color 0.2s;"
                                                           onfocus="this.style.borderColor='#2563eb'; this.style.outline='none'"
                                                           onblur="this.style.borderColor='#d1d5db'; updateEnvVar(${env.id}, ${idx}, 'key', this.value)">
                                                </div>
                                                <div style="flex: 2; display: flex; flex-direction: column; gap: 6px;">
                                                    <label style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Value</label>
                                                    <input type="text" value="${escapeHtml(value)}" placeholder="Variable value" 
                                                           style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: 'SF Mono', monospace; background: white; transition: border-color 0.2s;"
                                                           onfocus="this.style.borderColor='#2563eb'; this.style.outline='none'"
                                                           onblur="this.style.borderColor='#d1d5db'; updateEnvVar(${env.id}, ${idx}, 'value', this.value)">
                                                </div>
                                                <button onclick="removeEnvVar(${env.id}, ${idx})" 
                                                        style="padding: 8px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; margin-top: 20px;"
                                                        onmouseover="this.style.background='#fecaca'"
                                                        onmouseout="this.style.background='#fee2e2'"
                                                        title="Remove variable">√ó</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function addNewEnvironment() {
            // Use custom dialog for better UX
            if (typeof CustomDialog !== 'undefined' && CustomDialog.showPrompt) {
                const name = await CustomDialog.showPrompt('Enter environment name:', 'New Environment', 'Environment Name');
                if (!name || !name.trim()) return;
                await createEnvironment(name.trim());
            } else {
                const name = prompt('Enter environment name:');
                if (!name || !name.trim()) return;
                await createEnvironment(name.trim());
            }
        }
        
        async function createEnvironment(name) {
            try {
                const response = await fetch('/api/environments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, variables: '{}' })
                });
                
                if (response.ok) {
                    await loadEnvironmentsForManager();
                    await loadEnvironments();
                    // Show success message
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert(`Environment "${name}" created successfully!`, 'Success');
                    }
                } else {
                    throw new Error('Failed to create environment');
                }
            } catch (e) {
                console.error('Error adding environment:', e);
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert('Error adding environment: ' + e.message, 'Error');
                } else {
                    alert('Error adding environment');
                }
            }
        }
        
        async function updateEnvironmentName(envId) {
            const nameInput = document.getElementById('env-name-' + envId);
            if (!nameInput) return;
            
            const env = environments.find(e => e.id === envId);
            if (!env) return;
            
            env.name = nameInput.value;
        }
        
        function updateEnvVar(envId, varIdx, type, value) {
            const env = environments.find(e => e.id === envId);
            if (!env) return;
            
            const vars = env.variables ? (typeof env.variables === 'string' ? JSON.parse(env.variables) : env.variables) : {};
            const entries = Object.entries(vars);
            
            if (varIdx >= 0 && varIdx < entries.length) {
                if (type === 'key') {
                    const oldKey = entries[varIdx][0];
                    const oldValue = entries[varIdx][1];
                    if (oldKey !== value) {
                        delete vars[oldKey];
                        if (value && value.trim()) {
                            vars[value.trim()] = oldValue;
                        }
                    }
                } else {
                    const key = entries[varIdx][0];
                    if (key) {
                        vars[key] = value;
                    }
                }
                env.variables = JSON.stringify(vars);
            }
        }
        
        function addEnvVar(envId) {
            const env = environments.find(e => e.id === envId);
            if (!env) return;
            
            const vars = env.variables ? (typeof env.variables === 'string' ? JSON.parse(env.variables) : env.variables) : {};
            vars[''] = '';
            env.variables = JSON.stringify(vars);
            renderEnvironmentsList();
        }
        
        function removeEnvVar(envId, varIdx) {
            const env = environments.find(e => e.id === envId);
            if (!env) return;
            
            const vars = env.variables ? (typeof env.variables === 'string' ? JSON.parse(env.variables) : env.variables) : {};
            const entries = Object.entries(vars);
            
            if (varIdx >= 0 && varIdx < entries.length) {
                const key = entries[varIdx][0];
                delete vars[key];
                env.variables = JSON.stringify(vars);
                renderEnvironmentsList();
            }
        }
        
        async function saveEnvironment(envId) {
            const env = environments.find(e => e.id === envId);
            if (!env) return;
            
            try {
                const response = await fetch('/api/environments/' + envId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: env.name,
                        variables: env.variables
                    })
                });
                
                if (response.ok) {
                    await loadEnvironmentsForManager();
                    await loadEnvironments();
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert('Environment saved successfully!', 'Success');
                    } else {
                        alert('Environment saved successfully!');
                    }
                }
            } catch (e) {
                console.error('Error saving environment:', e);
                alert('Error saving environment');
            }
        }
        
        async function deleteEnvironment(envId) {
            const env = environments.find(e => e.id === envId);
            const envName = env ? env.name : 'this environment';
            
            let confirmed = false;
            if (typeof CustomDialog !== 'undefined' && CustomDialog.showConfirm) {
                confirmed = await CustomDialog.showConfirm(
                    `Are you sure you want to delete "${envName}"? This action cannot be undone.`,
                    'Delete Environment'
                );
            } else {
                confirmed = confirm(`Are you sure you want to delete "${envName}"?`);
            }
            
            if (!confirmed) return;
            
            try {
                const response = await fetch('/api/environments/' + envId, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadEnvironmentsForManager();
                    await loadEnvironments();
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert(`Environment "${envName}" deleted successfully.`, 'Success');
                    }
                } else {
                    throw new Error('Failed to delete environment');
                }
            } catch (e) {
                console.error('Error deleting environment:', e);
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert('Error deleting environment: ' + e.message, 'Error');
                } else {
                    alert('Error deleting environment');
                }
            }
        }
        
        async function loadEnvironments() {
            try {
                const response = await fetch('/api/environments');
                if (response.ok) {
                    environments = await response.json();
                    const select = document.getElementById('environmentSelect');
                    const topSelect = document.getElementById('topEnvSelect');
                    
                    if (select) {
                        select.innerHTML = '<option value="">No Environment</option>';
                        environments.forEach(env => {
                            const option = document.createElement('option');
                            option.value = env.id;
                            option.textContent = env.name + (env.isDefault ? ' (Default)' : '');
                            if (env.isDefault) {
                                option.selected = true;
                                currentEnvironmentId = env.id;
                            }
                            select.appendChild(option);
                        });
                        if (currentEnvironmentId) {
                            loadEnvironmentVariables();
                        }
                    }
                    
                    if (topSelect) {
                        topSelect.innerHTML = '<option value="">No Environment</option>';
                        environments.forEach(env => {
                            const option = document.createElement('option');
                            option.value = env.id;
                            option.textContent = env.name;
                            if (env.id === currentEnvironmentId) {
                                option.selected = true;
                            }
                            topSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading environments:', error);
            }
        }
        
        function switchTopEnvironment() {
            const topSelect = document.getElementById('topEnvSelect');
            const envSelect = document.getElementById('environmentSelect');
            if (topSelect && envSelect) {
                envSelect.value = topSelect.value;
                loadEnvironmentVariables();
            }
        }
        
        async function loadEnvironmentVariables() {
            const envSelect = document.getElementById('environmentSelect');
            const envId = envSelect ? envSelect.value : null;
            const varsContainer = document.getElementById('environmentVariables');
            const varsList = document.getElementById('environmentVariablesList');
            currentEnvironmentId = envId;
            
            // Update top selector too
            const topSelect = document.getElementById('topEnvSelect');
            if (topSelect) {
                topSelect.value = envId || '';
            }
            
            if (!envId || envId === '') {
                if (varsContainer) varsContainer.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch('/api/environments/' + envId);
                if (response.ok) {
                    const env = await response.json();
                    const vars = env.variables ? (typeof env.variables === 'string' ? JSON.parse(env.variables) : env.variables) : {};
                    
                    if (varsContainer) varsContainer.style.display = 'block';
                    if (varsList) {
                        const entries = Object.entries(vars);
                        if (entries.length === 0) {
                            varsList.innerHTML = '<span style="color: #6b7280;">No variables in this environment</span>';
                        } else {
                            varsList.innerHTML = entries.map(([key, value]) => 
                                `<div style="margin-bottom: 4px;"><strong style="color: #1a1a1a;">${escapeHtml(key)}:</strong> <span style="color: #6b7280;">${escapeHtml(value)}</span></div>`
                            ).join('');
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading environment variables:', e);
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        
        function toggleVariables() {
            const container = document.getElementById('variablesContainer');
            if (container) {
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function validateVariables() {
            const variablesEl = document.getElementById('variables');
            const validationDiv = document.getElementById('variableValidation');
            if (!variablesEl || !validationDiv) return;
            
            const variablesText = variablesEl.value;
            if (!variablesText || variablesText.trim() === '') {
                validationDiv.innerHTML = '';
                return;
            }
            
            const result = JSONFormatter.validate(variablesText);
            if (result.valid) {
                validationDiv.innerHTML = '<span style="color: #388e3c;">‚úì Valid JSON</span>';
            } else {
                validationDiv.innerHTML = '<span style="color: #d32f2f;">‚úó Invalid JSON: ' + escapeHtml(result.error) + '</span>';
            }
        }
        
        function formatVariables() {
            const variablesEl = document.getElementById('variables');
            if (!variablesEl) return;
            
            const variablesText = variablesEl.value;
            if (!variablesText || variablesText.trim() === '') return;
            
            const formatted = JSONFormatter.format(variablesText);
            variablesEl.value = formatted;
            validateVariables();
        }
        
        function previewVariableSubstitution() {
            const variablesEl = document.getElementById('variables');
            const urlEl = document.getElementById('url');
            const bodyEl = document.getElementById('body');
            const previewDiv = document.getElementById('variablePreview');
            const previewContent = document.getElementById('variablePreviewContent');
            
            if (!variablesEl || !previewDiv || !previewContent) return;
            
            const variablesText = variablesEl.value;
            const url = urlEl ? urlEl.value : '';
            const headers = getHeaders();
            const body = bodyEl ? bodyEl.value : '';
            
            if (!variablesText || variablesText.trim() === '') {
                previewDiv.style.display = 'none';
                return;
            }
            
            try {
                const variables = JSON.parse(variablesText);
                let preview = '';
                
                if (url) {
                    let previewUrl = url;
                    Object.keys(variables).forEach(key => {
                        previewUrl = previewUrl.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), variables[key]);
                    });
                    preview += '<div><strong>URL:</strong> ' + escapeHtml(previewUrl) + '</div>';
                }
                
                if (headers) {
                    let previewHeaders = headers;
                    Object.keys(variables).forEach(key => {
                        previewHeaders = previewHeaders.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), variables[key]);
                    });
                    preview += '<div style="margin-top: 8px;"><strong>Headers:</strong><br><pre style="margin-top: 4px; white-space: pre-wrap;">' + escapeHtml(previewHeaders) + '</pre></div>';
                }
                
                if (body) {
                    let previewBody = body;
                    Object.keys(variables).forEach(key => {
                        previewBody = previewBody.replace(new RegExp('\\{\\{' + key + '\\}\\}', 'g'), variables[key]);
                    });
                    preview += '<div style="margin-top: 8px;"><strong>Body:</strong><br><pre style="margin-top: 4px; white-space: pre-wrap;">' + escapeHtml(previewBody) + '</pre></div>';
                }
                
                if (preview) {
                    previewContent.innerHTML = preview;
                    previewDiv.style.display = 'block';
                } else {
                    previewDiv.style.display = 'none';
                }
            } catch (error) {
                previewContent.innerHTML = '<span style="color: #d32f2f;">Error: Invalid variables JSON</span>';
                previewDiv.style.display = 'block';
            }
        }
        
        function validateBody() {
            const bodyEl = document.getElementById('body');
            const bodyTypeEl = document.getElementById('bodyType');
            const validationDiv = document.getElementById('bodyValidation');
            
            if (!bodyEl || !bodyTypeEl || !validationDiv) return;
            
            const bodyText = bodyEl.value;
            const bodyType = bodyTypeEl.value;
            
            if (!bodyText || bodyText.trim() === '' || bodyType === 'none') {
                validationDiv.innerHTML = '';
                return;
            }
            
            if (bodyType === 'json') {
                const result = JSONFormatter.validate(bodyText);
                if (result.valid) {
                    validationDiv.innerHTML = '<span style="color: #388e3c;">‚úì Valid JSON</span>';
                } else {
                    validationDiv.innerHTML = '<span style="color: #d32f2f;">‚úó Invalid JSON: ' + escapeHtml(result.error) + '</span>';
                }
            } else if (bodyType === 'xml') {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(bodyText, 'text/xml');
                    if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                        validationDiv.innerHTML = '<span style="color: #d32f2f;">‚úó Invalid XML</span>';
                    } else {
                        validationDiv.innerHTML = '<span style="color: #388e3c;">‚úì Valid XML</span>';
                    }
                } catch (error) {
                    validationDiv.innerHTML = '<span style="color: #d32f2f;">‚úó Invalid XML</span>';
                }
            } else {
                validationDiv.innerHTML = '';
            }
        }
        
        function formatBody() {
            const bodyEl = document.getElementById('body');
            const bodyTypeEl = document.getElementById('bodyType');
            
            if (!bodyEl || !bodyTypeEl) return;
            
            const bodyText = bodyEl.value;
            const bodyType = bodyTypeEl.value;
            
            if (!bodyText || bodyText.trim() === '') return;
            
            if (bodyType === 'json') {
                const formatted = JSONFormatter.format(bodyText);
                bodyEl.value = formatted;
                validateBody();
            } else if (bodyType === 'xml') {
                const formatted = JSONFormatter.formatXML(bodyText);
                bodyEl.value = formatted;
                validateBody();
            }
        }
        
        function formatBodyIfNeeded() {
            const bodyEl = document.getElementById('body');
            const bodyTypeEl = document.getElementById('bodyType');
            
            if (!bodyEl || !bodyTypeEl) return;
            
            const bodyText = bodyEl.value;
            const bodyType = bodyTypeEl.value;
            
            if (bodyType === 'json' && bodyText && bodyText.trim()) {
                const result = JSONFormatter.validate(bodyText);
                if (result.valid) {
                    const formatted = JSONFormatter.format(bodyText);
                    if (formatted !== bodyText) {
                        // Auto-format on blur if valid
                        bodyEl.value = formatted;
                    }
                }
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function openEnvironmentManager() {
            const modal = document.createElement('div');
            modal.className = 'custom-dialog-overlay';
            modal.innerHTML = `
                <div class="custom-dialog" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <div class="custom-dialog-header">
                        <h3>Environment Management</h3>
                        <button class="custom-dialog-close" onclick="this.closest('.custom-dialog-overlay').remove()">&times;</button>
                    </div>
                    <div class="custom-dialog-body">
                        <div style="margin-bottom: 20px;">
                            <button onclick="createNewEnvironment()" style="padding: 8px 16px; background: #1a1a1a; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">+ New Environment</button>
                        </div>
                        <div id="environmentsList"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            await loadEnvironmentsForManager();
        }
        
        async function loadEnvironmentsForManager() {
            try {
                const response = await fetch('/api/environments');
                if (response.ok) {
                    const envs = await response.json();
                    const listDiv = document.getElementById('environmentsList');
                    if (!listDiv) return;
                    listDiv.innerHTML = '';
                    
                    envs.forEach(env => {
                        const envDiv = document.createElement('div');
                        envDiv.style.cssText = 'padding: 12px; border: 1px solid #e5e5e5; border-radius: 4px; margin-bottom: 12px;';
                        envDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div>
                                    <strong>${escapeHtml(env.name)}</strong>
                                    ${env.isDefault ? '<span style="color: #388e3c; font-size: 11px; margin-left: 8px;">(Default)</span>' : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${!env.isDefault ? `<button onclick="setDefaultEnvironment(${env.id})" style="padding: 4px 8px; font-size: 11px; background: #f5f5f5; border: 1px solid #e5e5e5; border-radius: 4px; cursor: pointer;">Set Default</button>` : ''}
                                    <button onclick="editEnvironment(${env.id})" style="padding: 4px 8px; font-size: 11px; background: #f5f5f5; border: 1px solid #e5e5e5; border-radius: 4px; cursor: pointer;">Edit</button>
                                    <button onclick="deleteEnvironment(${env.id})" style="padding: 4px 8px; font-size: 11px; background: #ffebee; border: 1px solid #d32f2f; color: #d32f2f; border-radius: 4px; cursor: pointer;">Delete</button>
                                </div>
                            </div>
                            ${env.description ? `<div style="font-size: 12px; color: #8a8a8a; margin-bottom: 8px;">${escapeHtml(env.description)}</div>` : ''}
                            <div style="font-size: 11px; color: #8a8a8a; font-family: monospace; background: #fafafa; padding: 8px; border-radius: 4px; max-height: 100px; overflow-y: auto;">${escapeHtml(env.variables || '{}')}</div>
                        `;
                        listDiv.appendChild(envDiv);
                    });
                }
            } catch (error) {
                console.error('Error loading environments:', error);
            }
        }
        
        async function createNewEnvironment() {
            const name = await CustomDialog.showPrompt('Environment Name:', '', 'New Environment');
            if (!name) return;
            
            const description = await CustomDialog.showPrompt('Description (optional):', '', 'Environment Description');
            
            const variables = await CustomDialog.showPrompt('Variables (JSON):', '{}', 'Environment Variables');
            if (variables === null) return;
            
            try {
                const response = await fetch('/api/environments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: description || '',
                        variables: variables || '{}',
                        isDefault: false
                    })
                });
                
                if (response.ok) {
                    await loadEnvironmentsForManager();
                    await loadEnvironments();
                } else {
                    await CustomDialog.showAlert('Error creating environment', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            }
        }
        
        async function editEnvironment(id) {
            try {
                const response = await fetch('/api/environments/' + id);
                if (response.ok) {
                    const env = await response.json();
                    const name = await CustomDialog.showPrompt('Environment Name:', env.name, 'Edit Environment');
                    if (name === null) return;
                    
                    const description = await CustomDialog.showPrompt('Description:', env.description || '', 'Environment Description');
                    
                    const variables = await CustomDialog.showPrompt('Variables (JSON):', env.variables || '{}', 'Environment Variables');
                    if (variables === null) return;
                    
                    const updateResponse = await fetch('/api/environments/' + id, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: name,
                            description: description || '',
                            variables: variables || '{}',
                            isDefault: env.isDefault
                        })
                    });
                    
                    if (updateResponse.ok) {
                        await loadEnvironmentsForManager();
                        await loadEnvironments();
                    } else {
                        await CustomDialog.showAlert('Error updating environment', 'Error');
                    }
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            }
        }
        
        async function deleteEnvironment(id) {
            const confirmed = await CustomDialog.showConfirm('Are you sure you want to delete this environment?', 'Delete Environment');
            if (!confirmed) return;
            
            try {
                const response = await fetch('/api/environments/' + id, { method: 'DELETE' });
                if (response.ok) {
                    await loadEnvironmentsForManager();
                    await loadEnvironments();
                } else {
                    await CustomDialog.showAlert('Error deleting environment', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            }
        }
        
        async function setDefaultEnvironment(id) {
            try {
                const response = await fetch('/api/environments/' + id + '/set-default', { method: 'POST' });
                if (response.ok) {
                    await loadEnvironmentsForManager();
                    await loadEnvironments();
                } else {
                    await CustomDialog.showAlert('Error setting default environment', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            }
        }
        
        async function exportAll() {
            try {
                const response = await fetch('/api/export');
                if (response.ok) {
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'bisen-export-' + new Date().toISOString().split('T')[0] + '.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    await CustomDialog.showAlert('Export successful!', 'Success');
                } else {
                    await CustomDialog.showAlert('Error exporting data', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            }
        }
        
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                const confirmed = await CustomDialog.showConfirm(
                    'This will import all collections, requests, and environments. Continue?',
                    'Import BISEN Format'
                );
                
                if (!confirmed) {
                    event.target.value = '';
                    return;
                }
                
                const response = await fetch('/api/import/bisen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    await CustomDialog.showAlert(
                        `Import successful! Created ${result.collectionsCreated || 0} collections, ${result.requestsCreated || 0} requests, and ${result.environmentsCreated || 0} environments.`,
                        'Import Success'
                    );
                    location.reload();
                } else {
                    await CustomDialog.showAlert('Error importing data', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            } finally {
                event.target.value = '';
            }
        }
        
        function filterSidebarRequests() {
            const searchTerm = document.getElementById('sidebarSearch').value.toLowerCase();
            const requestItems = document.querySelectorAll('.saved-request-item');
            
            requestItems.forEach(item => {
                const name = item.querySelector('.saved-request-name')?.textContent.toLowerCase() || '';
                const url = item.querySelector('.saved-request-url')?.textContent.toLowerCase() || '';
                const method = item.querySelector('.saved-request-method')?.textContent.toLowerCase() || '';
                
                if (name.includes(searchTerm) || url.includes(searchTerm) || method.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Also filter collections
            const collections = document.querySelectorAll('.collection-item');
            collections.forEach(collection => {
                const collectionName = collection.querySelector('.collection-name')?.textContent.toLowerCase() || '';
                const hasVisibleRequests = Array.from(collection.querySelectorAll('.saved-request-item'))
                    .some(item => item.style.display !== 'none');
                
                if (collectionName.includes(searchTerm) || hasVisibleRequests) {
                    collection.style.display = '';
                } else {
                    collection.style.display = 'none';
                }
            });
        }
        
        async function copyResponse() {
            const responseBody = document.getElementById('responseBody');
            const text = responseBody.textContent || responseBody.innerText;
            
            try {
                await navigator.clipboard.writeText(text);
                const btn = document.querySelector('.btn-copy-response');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>Copied!</span>';
                btn.style.background = '#1a1a1a';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = 'transparent';
                    btn.style.color = '#1a1a1a';
                }, 2000);
            } catch (err) {
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert('Failed to copy: ' + err, 'Error');
                } else {
                    alert('Failed to copy: ' + err);
                }
            }
        }
        
        function duplicateRequest(requestId) {
            // Load the saved request and populate the form
            loadSavedRequestFromSidebar(requestId);
            // Clear the saved request ID so it creates a new one
            document.getElementById('savedRequestId').value = '';
            // Change the name to indicate it's a duplicate
            const nameInput = document.getElementById('name');
            if (nameInput.value) {
                nameInput.value = nameInput.value + ' (Copy)';
            }
        }
        
        function clearForm() {
            document.getElementById('requestForm').reset();
            document.getElementById('savedRequestId').value = '';
            document.getElementById('responseSection').style.display = 'none';
            document.getElementById('bodyType').value = 'json';
            document.getElementById('authType').value = 'none';
            document.getElementById('timeout').value = '30000';
            document.getElementById('variablesContainer').style.display = 'none';
            document.getElementById('variables').value = '';
            document.getElementById('environmentSelect').value = '';
            // Collections are deprecated - no need to clear
            document.getElementById('applicationId').value = '';
            updateBodyType();
            updateAuthType();
            setHeaders('');
            
            // Reset title and breadcrumb
            const titleEl = document.getElementById('requestTitle');
            const breadcrumbEl = document.getElementById('requestBreadcrumb');
            if (titleEl) {
                titleEl.textContent = 'New Request';
            }
            if (breadcrumbEl) {
                breadcrumbEl.textContent = '';
                breadcrumbEl.style.display = 'none';
            }
            
            // Hide application info
            const appInfo = document.getElementById('applicationInfo');
            if (appInfo) {
                appInfo.style.display = 'none';
            }
        }
        
        // Make function globally available
        window.clearForm = clearForm;
        
        function updateBodyType() {
            const bodyType = document.getElementById('bodyType').value;
            const bodyTextarea = document.getElementById('body');
            const hintDiv = document.getElementById('bodyTypeHint');
            
            // Update Content-Type header automatically
            updateContentTypeHeader(bodyType);
            
            // Update placeholder and hint based on type
            switch(bodyType) {
                case 'json':
                    bodyTextarea.placeholder = '{"key": "value", "name": "BISEN"}';
                    hintDiv.textContent = 'üí° Enter valid JSON format';
                    break;
                case 'xml':
                    bodyTextarea.placeholder = '<?xml version="1.0"?>\n<root>\n  <key>value</key>\n</root>';
                    hintDiv.textContent = 'üí° Enter valid XML format';
                    break;
                case 'form-data':
                    bodyTextarea.placeholder = 'key1=value1\nkey2=value2\nkey3=value3';
                    hintDiv.textContent = 'üí° Enter key=value pairs (one per line)';
                    break;
                case 'x-www-form-urlencoded':
                    bodyTextarea.placeholder = 'key1=value1&key2=value2&key3=value3';
                    hintDiv.textContent = 'üí° Enter URL-encoded form data (key=value&key=value)';
                    break;
                case 'text':
                    bodyTextarea.placeholder = 'Enter plain text here...';
                    hintDiv.textContent = 'üí° Enter plain text content';
                    break;
                case 'html':
                    bodyTextarea.placeholder = '<html><body><h1>Hello</h1></body></html>';
                    hintDiv.textContent = 'üí° Enter HTML content';
                    break;
                case 'none':
                    bodyTextarea.placeholder = '';
                    hintDiv.textContent = 'üí° No body will be sent';
                    bodyTextarea.value = '';
                    break;
                default:
                    bodyTextarea.placeholder = '{"key": "value"}';
                    hintDiv.textContent = '';
            }
        }
        
        function updateContentTypeHeader(bodyType) {
            try {
                if (!bodyType || typeof bodyType !== 'string') {
                    return;
                }
                
                const contentTypeMap = {
                    'json': 'application/json',
                    'xml': 'application/xml',
                    'form-data': 'multipart/form-data',
                    'x-www-form-urlencoded': 'application/x-www-form-urlencoded',
                    'text': 'text/plain',
                    'html': 'text/html',
                    'none': ''
                };
                
                const contentType = contentTypeMap[bodyType] || 'application/json';
                
                // Find or create Content-Type header
                const headerRows = document.querySelectorAll('.header-row');
                let found = false;
                
                headerRows.forEach(row => {
                    const keyInput = row.querySelector('.header-key');
                    const valueInput = row.querySelector('.header-value');
                    if (keyInput && valueInput && keyInput.value.trim().toLowerCase() === 'content-type') {
                        if (bodyType === 'none') {
                            // Remove Content-Type for none
                            if (headerRows.length > 1) {
                                row.remove();
                            } else {
                                keyInput.value = '';
                                valueInput.value = '';
                            }
                        } else {
                            valueInput.value = contentType;
                        }
                        found = true;
                    }
                });
                
                // If Content-Type not found and not 'none', add it
                if (!found && bodyType !== 'none') {
                    const container = document.getElementById('headersContainer');
                    if (container) {
                        const newRow = document.createElement('div');
                        newRow.className = 'header-row';
                        newRow.innerHTML = `
                            <input type="text" class="header-key" placeholder="Key" value="Content-Type">
                            <input type="text" class="header-value" placeholder="Value" value="${contentType}">
                            <button type="button" class="btn-remove-header" onclick="removeHeader(this)">Remove</button>
                        `;
                        container.insertBefore(newRow, container.firstChild);
                    }
                }
            } catch (e) {
                console.error('Error updating Content-Type header:', e);
            }
        }
        
        function detectBodyTypeFromHeaders() {
            try {
                const headers = getHeaders();
                if (!headers || typeof headers !== 'string') {
                    return;
                }
                
                const contentTypeMatch = headers.match(/content-type:\s*([^\n]+)/i);
                
                if (contentTypeMatch && contentTypeMatch[1]) {
                    const contentType = contentTypeMatch[1].trim().toLowerCase();
                    let bodyType = 'json'; // default
                    
                    if (contentType.includes('application/json')) {
                        bodyType = 'json';
                    } else if (contentType.includes('application/xml') || contentType.includes('text/xml')) {
                        bodyType = 'xml';
                    } else if (contentType.includes('multipart/form-data')) {
                        bodyType = 'form-data';
                    } else if (contentType.includes('application/x-www-form-urlencoded')) {
                        bodyType = 'x-www-form-urlencoded';
                    } else if (contentType.includes('text/html')) {
                        bodyType = 'html';
                    } else if (contentType.includes('text/plain')) {
                        bodyType = 'text';
                    }
                    
                    const bodyTypeEl = document.getElementById('bodyType');
                    if (bodyTypeEl) {
                        bodyTypeEl.value = bodyType;
                        updateBodyType();
                    }
                }
            } catch (e) {
                console.error('Error detecting body type:', e);
            }
        }
        
        async function saveRequest() {
            const nameEl = document.getElementById('name');
            const methodEl = document.getElementById('method');
            const urlEl = document.getElementById('url');
            const bodyEl = document.getElementById('body');
            const savedRequestIdEl = document.getElementById('savedRequestId');
            
            if (!methodEl || !urlEl) {
                await CustomDialog.showAlert('Form elements not found', 'Error');
                return;
            }
            
            const method = methodEl.value ? methodEl.value.trim() : '';
            const url = urlEl.value ? urlEl.value.trim() : '';
            
            if (!method || !url) {
                await CustomDialog.showAlert('Please fill in Method and URL before saving', 'Validation Error');
                return;
            }
            
            const name = nameEl ? (nameEl.value || '') : '';
            const headers = getHeaders();
            const body = bodyEl ? (bodyEl.value || '') : '';
            const applicationIdEl = document.getElementById('applicationId');
            const applicationId = applicationIdEl ? applicationIdEl.value : '';
            const savedRequestId = savedRequestIdEl ? savedRequestIdEl.value : '';
            
            let requestName = name;
            if (!requestName) {
                requestName = await CustomDialog.showPrompt('Enter a name for this request:', '', 'Request Name');
                if (!requestName) {
                    return;
                }
                document.getElementById('name').value = requestName;
            }
            
            const savedRequestDto = {
                id: savedRequestId || null,
                name: requestName,
                method: method,
                url: url,
                headers: headers,
                body: body,
                collectionId: null, // Collections are deprecated, use applications instead
                applicationId: applicationId ? parseInt(applicationId) : null
            };
            
            try {
                console.log('Saving request with data:', savedRequestDto);
                
                const response = await fetch('/api/saved', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(savedRequestDto)
                });
                
                if (response.ok) {
                    const savedRequest = await response.json();
                    console.log('Saved request response:', savedRequest);
                    document.getElementById('savedRequestId').value = savedRequest.id;
                    
                    // Update title after saving
                    updateRequestTitle(requestName, savedRequest);
                    
                    let successMessage = 'Request saved successfully!';
                    if (applicationId) {
                        const selectedApp = applications.find(app => app.id === parseInt(applicationId));
                        if (selectedApp) {
                            successMessage = `Request saved successfully and assigned to ${selectedApp.project.name} > ${selectedApp.name}!`;
                        }
                    }
                    
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert(successMessage, 'Success');
                    } else {
                        alert(successMessage);
                    }
                    
                    // Reload sidebar to show updated hierarchy
                    await loadAllSavedRequests();
                } else {
                    const errorText = await response.text();
                    console.error('Error saving request:', response.status, errorText);
                    let errorMessage = 'Error saving request';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                        await CustomDialog.showAlert(errorMessage, 'Error');
                    } else {
                        alert(errorMessage);
                    }
                }
            } catch (error) {
                console.error('Exception saving request:', error);
                const errorMessage = 'Error: ' + (error.message || 'Unknown error occurred');
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    await CustomDialog.showAlert(errorMessage, 'Error');
                } else {
                    alert(errorMessage);
                }
            }
        }
        
        let currentRequestId = null;
        let collectionMenu = null;
        
        function showAddToCollectionMenu(event, requestId) {
            event.stopPropagation();
            currentRequestId = requestId;
            
            // Remove existing menu if any
            if (collectionMenu) {
                collectionMenu.remove();
            }
            
            // Create menu
            collectionMenu = document.createElement('div');
            collectionMenu.className = 'collection-menu';
            collectionMenu.style.left = event.pageX + 'px';
            collectionMenu.style.top = event.pageY + 'px';
            
            // Add header
            const header = document.createElement('div');
            header.className = 'collection-menu-item';
            header.textContent = 'Add to Collection';
            collectionMenu.appendChild(header);
            
            // Add "Remove from Collection" option
            const removeOption = document.createElement('div');
            removeOption.className = 'collection-menu-item';
            removeOption.textContent = 'Remove from Collection';
            removeOption.onclick = function() {
                addToCollection(null);
            };
            collectionMenu.appendChild(removeOption);
            
            // Add collections from server data or DOM
            if (window.collections && window.collections.length > 0) {
                window.collections.forEach(collection => {
                    const option = document.createElement('div');
                    option.className = 'collection-menu-item';
                    option.textContent = collection.name;
                    option.onclick = function() {
                        addToCollection(collection.id);
                    };
                    collectionMenu.appendChild(option);
                });
            } else {
                // Fallback: extract from DOM
                const collectionItems = document.querySelectorAll('.collection-item');
                collectionItems.forEach(item => {
                    const collectionName = item.querySelector('.collection-name').textContent;
                    const collectionHeader = item.querySelector('.collection-header');
                    const collectionId = collectionHeader.getAttribute('data-collection-id');
                    
                    if (collectionId && collectionName !== 'Unassigned Requests') {
                        const option = document.createElement('div');
                        option.className = 'collection-menu-item';
                        option.textContent = collectionName;
                        option.onclick = function() {
                            addToCollection(parseInt(collectionId));
                        };
                        collectionMenu.appendChild(option);
                    }
                });
            }
            
            // Add click outside to close
            document.body.appendChild(collectionMenu);
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    if (collectionMenu) {
                        collectionMenu.remove();
                        collectionMenu = null;
                    }
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }
        
        async function addToCollection(collectionId) {
            if (!currentRequestId) return;
            
            try {
                const response = await fetch(`/api/saved/${currentRequestId}/collection`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ collectionId: collectionId ? parseInt(collectionId) : null })
                });
                
                if (response.ok) {
                    if (collectionMenu) {
                        collectionMenu.remove();
                        collectionMenu = null;
                    }
                    location.reload();
                } else {
                    await CustomDialog.showAlert('Error updating collection', 'Error');
                }
            } catch (error) {
                await CustomDialog.showAlert('Error: ' + error.message, 'Error');
            }
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize body type and auth type
            updateBodyType();
            updateAuthType();
            
            // Handle button clicks in sidebar
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.addEventListener('click', function(e) {
                    // Handle duplicate button
                    const duplicateBtn = e.target.closest('button.btn-duplicate');
                    if (duplicateBtn) {
                        e.stopPropagation();
                        const requestId = duplicateBtn.getAttribute('data-request-id');
                        if (requestId) {
                            duplicateRequest(parseInt(requestId));
                        }
                        return false;
                    }
                    
                    // Handle add to collection button
                    const addCollectionBtn = e.target.closest('button.btn-add-collection');
                    if (addCollectionBtn) {
                        e.stopPropagation();
                        const requestId = addCollectionBtn.getAttribute('data-request-id');
                        if (requestId) {
                            showAddToCollectionMenu(e, parseInt(requestId));
                        }
                        return false;
                    }
                });
            }
            
            // Collections are no longer used - using Projects/Applications instead
            
            const loadData = sessionStorage.getItem('loadSavedRequest');
            if (loadData) {
                const saved = JSON.parse(loadData);
                sessionStorage.removeItem('loadSavedRequest');
                
                document.getElementById('savedRequestId').value = saved.id;
                document.getElementById('name').value = saved.name || '';
                document.getElementById('method').value = saved.method;
                document.getElementById('url').value = saved.url;
                setHeaders(saved.headers || '');
                document.getElementById('body').value = saved.body || '';
                // Load application if available
                if (saved.applicationId) {
                    const applicationSelect = document.getElementById('applicationId');
                    if (applicationSelect) {
                        applicationSelect.value = saved.applicationId;
                        updateApplicationInfo();
                    }
                } else {
                    const applicationSelect = document.getElementById('applicationId');
                    if (applicationSelect) {
                        applicationSelect.value = '';
                        updateApplicationInfo();
                    }
                }
                
                // Detect and set body type
                detectBodyTypeFromHeaders();
            }
            // Load environments on page load
            loadEnvironments();
            
            // Load projects and applications
            loadProjectsAndApplications();
            
            // Load all saved requests
            loadAllSavedRequests();
            
            const applicationSelect = document.getElementById('applicationId');
            if (applicationSelect) {
                applicationSelect.addEventListener('change', updateApplicationInfo);
            }
        });
        
        // Load applications on page load
        let projects = [];
        let applications = [];
        
        async function loadProjectsAndApplications() {
            try {
                console.log('Loading projects and applications...');
                const projectsResponse = await fetch('/api/projects');
                if (!projectsResponse.ok) {
                    console.error('Failed to load projects:', projectsResponse.status);
                    return;
                }
                projects = await projectsResponse.json();
                console.log('Loaded projects:', projects.length);
                
                // Load applications for all projects
                applications = [];
                for (const project of projects) {
                    try {
                        const appsResponse = await fetch(`/api/projects/${project.id}/applications`);
                        if (appsResponse.ok) {
                            const projectApps = await appsResponse.json();
                            console.log(`Loaded ${projectApps.length} applications for project ${project.name}`);
                            projectApps.forEach(app => {
                                app.project = project; // Attach project info
                                applications.push(app);
                            });
                        } else {
                            console.warn(`Failed to load applications for project ${project.id}:`, appsResponse.status);
                        }
                    } catch (error) {
                        console.error(`Error loading applications for project ${project.id}:`, error);
                    }
                }
                
                console.log('Total applications loaded:', applications.length);
                updateApplicationSelect();
                // Render sidebar with projects/applications/APIs
                renderSidebarHierarchy();
            } catch (error) {
                console.error('Error loading projects and applications:', error);
                if (typeof CustomDialog !== 'undefined' && CustomDialog.showAlert) {
                    CustomDialog.showAlert('Error loading projects and applications. Please refresh the page.', 'Error');
                }
            }
        }
        
        // Load all saved requests
        let allSavedRequests = [];
        
        async function loadAllSavedRequests() {
            try {
                const response = await fetch('/api/saved');
                if (response.ok) {
                    allSavedRequests = await response.json();
                    console.log('Loaded saved requests:', allSavedRequests.length);
                    renderSidebarHierarchy();
                } else {
                    console.error('Failed to load saved requests:', response.status);
                }
            } catch (error) {
                console.error('Error loading saved requests:', error);
            }
        }
        
        // Render Projects > Applications > APIs hierarchy in sidebar
        function renderSidebarHierarchy() {
            const container = document.getElementById('projects-container');
            const emptyState = document.getElementById('empty-projects-state');
            const unassignedContainer = document.getElementById('unassigned-requests-container');
            
            if (!container) return;
            
            // Filter unassigned requests
            const unassignedRequests = allSavedRequests.filter(req => !req.application || !req.application.id);
            
            // Show/hide empty state
            if (projects.length === 0 && unassignedRequests.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                container.innerHTML = '';
            } else {
                if (emptyState) emptyState.style.display = 'none';
                
                let html = '';
                
                // Render each project
                projects.forEach(project => {
                    const projectApps = applications.filter(app => app.project && app.project.id === project.id);
                    
                    html += `
                        <div class="collection-item" data-project-id="${project.id}">
                            <div class="collection-header" 
                                 data-project-id="${project.id}"
                                 onclick="toggleProject(${project.id})">
                                <span class="collection-name">${escapeHtml(project.name)}</span>
                                <span class="collection-toggle" id="toggle-project-${project.id}">‚ñº</span>
                            </div>
                            <div class="collection-requests" id="project-${project.id}" style="display: block;">
                                ${projectApps.length === 0 ? `
                                    <div style="padding: 8px 12px; color: #9ca3af; font-size: 11px; font-style: italic;">
                                        No applications in this project
                                    </div>
                                ` : projectApps.map(app => {
                                    const appRequests = allSavedRequests.filter(req => 
                                        req.application && req.application.id === app.id
                                    );
                                    
                                    return `
                                        <div class="application-item" data-application-id="${app.id}">
                                            <div class="application-header" 
                                                 data-application-id="${app.id}"
                                                 onclick="toggleApplication(${app.id})">
                                                <span class="application-name">${escapeHtml(app.name)}${app.version ? ' (' + escapeHtml(app.version) + ')' : ''}</span>
                                                <span class="application-toggle" id="toggle-app-${app.id}">‚ñº</span>
                                            </div>
                                            <div class="application-requests" id="app-${app.id}" style="display: block;">
                                                ${appRequests.length === 0 ? `
                                                    <div style="padding: 6px 12px; color: #9ca3af; font-size: 10px; font-style: italic;">
                                                        No APIs in this application
                                                    </div>
                                                ` : appRequests.map(req => `
                                                    <div class="saved-request-item nested" 
                                                         data-request-id="${req.id}"
                                                         onclick="if(!event.target.closest('button')){loadSavedRequestFromSidebar(${req.id});}">
                                                        <div class="saved-request-name">${escapeHtml(req.name || 'Untitled')}</div>
                                                        <div>
                                                            <span class="saved-request-method method-${req.method}" style="margin-right: 6px;">${escapeHtml(req.method)}</span>
                                                            <span class="saved-request-url">${escapeHtml(req.url || '')}</span>
                                                        </div>
                                                        <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                                                            <button class="btn-add-to-collection btn-duplicate" 
                                                                    data-request-id="${req.id}"
                                                                    title="Duplicate Request"
                                                                    style="width: 20px; height: 20px; font-size: 11px;">‚ßâ</button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Render unassigned requests
                if (unassignedRequests.length > 0) {
                    if (unassignedContainer) {
                        unassignedContainer.style.display = 'block';
                        const unassignedDiv = unassignedContainer.querySelector('#project-unassigned');
                        if (unassignedDiv) {
                            unassignedDiv.innerHTML = unassignedRequests.map(req => `
                                <div class="saved-request-item nested" 
                                     data-request-id="${req.id}"
                                     onclick="if(!event.target.closest('button')){loadSavedRequestFromSidebar(${req.id});}">
                                    <div class="saved-request-name">${escapeHtml(req.name || 'Untitled')}</div>
                                    <div>
                                        <span class="saved-request-method method-${req.method}" style="margin-right: 6px;">${escapeHtml(req.method)}</span>
                                        <span class="saved-request-url">${escapeHtml(req.url || '')}</span>
                                    </div>
                                    <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                                        <button class="btn-add-to-collection btn-duplicate" 
                                                data-request-id="${req.id}"
                                                title="Duplicate Request"
                                                style="width: 20px; height: 20px; font-size: 11px;">‚ßâ</button>
                                    </div>
                                </div>
                            `).join('');
                        }
                    }
                } else {
                    if (unassignedContainer) unassignedContainer.style.display = 'none';
                }
            }
        }
        
        // Toggle project expansion
        function toggleProject(projectId) {
            const projectDiv = document.getElementById(`project-${projectId}`);
            const toggle = document.getElementById(`toggle-project-${projectId}`);
            
            if (projectDiv && toggle) {
                if (projectDiv.style.display === 'none') {
                    projectDiv.style.display = 'block';
                    toggle.classList.remove('collapsed');
                } else {
                    projectDiv.style.display = 'none';
                    toggle.classList.add('collapsed');
                }
            }
        }
        
        // Toggle application expansion
        function toggleApplication(applicationId) {
            const appDiv = document.getElementById(`app-${applicationId}`);
            const toggle = document.getElementById(`toggle-app-${applicationId}`);
            
            if (appDiv && toggle) {
                if (appDiv.style.display === 'none') {
                    appDiv.style.display = 'block';
                    toggle.classList.remove('collapsed');
                } else {
                    appDiv.style.display = 'none';
                    toggle.classList.add('collapsed');
                }
            }
        }
        
        window.toggleProject = toggleProject;
        window.toggleApplication = toggleApplication;
        
        function updateApplicationSelect() {
            const select = document.getElementById('applicationId');
            if (!select) {
                console.warn('Application select element not found');
                return;
            }
            
            select.innerHTML = '<option value="">-- No Application --</option>';
            
            if (applications.length === 0) {
                console.log('No applications available');
                return;
            }
            
            applications.forEach(app => {
                if (!app.id || !app.project || !app.project.name || !app.name) {
                    console.warn('Invalid application data:', app);
                    return;
                }
                
                const option = document.createElement('option');
                option.value = app.id;
                option.textContent = `${app.project.name} > ${app.name}${app.version ? ' (' + app.version + ')' : ''}`;
                option.dataset.projectName = app.project.name;
                option.dataset.appName = app.name;
                select.appendChild(option);
            });
            
            console.log(`Populated application select with ${applications.length} applications`);
        }
        
        function updateApplicationInfo() {
            const select = document.getElementById('applicationId');
            const infoDiv = document.getElementById('applicationInfo');
            const projectNameSpan = document.getElementById('applicationProjectName');
            const appNameSpan = document.getElementById('applicationName');
            
            if (!select || !infoDiv) return;
            
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption && selectedOption.value) {
                infoDiv.style.display = 'block';
                if (projectNameSpan) projectNameSpan.textContent = selectedOption.dataset.projectName || '';
                if (appNameSpan) appNameSpan.textContent = selectedOption.dataset.appName || '';
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        window.updateApplicationInfo = updateApplicationInfo;
        
        // Project Assignment Modal Functions
        async function openProjectAssignmentModal() {
            const modal = document.getElementById('projectAssignmentModal');
            if (!modal) {
                console.error('Project assignment modal not found');
                return;
            }
            
            // Ensure projects and applications are loaded
            if (projects.length === 0) {
                await loadProjectsAndApplications();
            }
            
            // Render projects and applications
            renderProjectAssignmentList();
            
            modal.style.display = 'flex';
        }
        
        function closeProjectAssignmentModal() {
            const modal = document.getElementById('projectAssignmentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function renderProjectAssignmentList() {
            const container = document.getElementById('projectAssignmentList');
            if (!container) return;
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">No projects available</div>
                        <div style="font-size: 13px;">Create a project first from the <a href="/projects" style="color: #2563eb; text-decoration: none;">Projects page</a></div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            projects.forEach(project => {
                const projectApps = applications.filter(app => app.project && app.project.id === project.id);
                html += `
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <div style="padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-size: 16px; font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">${escapeHtml(project.name)}</div>
                            ${project.description ? `<div style="font-size: 12px; color: #6b7280;">${escapeHtml(project.description)}</div>` : ''}
                        </div>
                        <div style="padding: 12px;">
                            ${projectApps.length === 0 ? `
                                <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                                    No applications in this project
                                </div>
                            ` : projectApps.map(app => `
                                <button onclick="selectApplication(${app.id}, '${escapeHtml(project.name)}', '${escapeHtml(app.name)}', '${escapeHtml(app.version || '')}')" 
                                        style="width: 100%; padding: 12px; margin-bottom: 8px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; text-align: left; transition: all 0.2s;"
                                        onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#2563eb'"
                                        onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb'">
                                    <div style="font-size: 14px; font-weight: 500; color: #1a1a1a; margin-bottom: 2px;">${escapeHtml(app.name)}</div>
                                    ${app.version ? `<div style="font-size: 12px; color: #6b7280;">Version: ${escapeHtml(app.version)}</div>` : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function selectApplication(applicationId, projectName, appName, appVersion) {
            const hiddenInput = document.getElementById('applicationId');
            if (hiddenInput) {
                hiddenInput.value = applicationId;
            }
            
            // Update the assignment info display
            const noAssignment = document.getElementById('noAssignment');
            const assignmentInfo = document.getElementById('assignmentInfo');
            const assignedProjectName = document.getElementById('assignedProjectName');
            const assignedApplicationName = document.getElementById('assignedApplicationName');
            const assignedApplicationVersion = document.getElementById('assignedApplicationVersion');
            
            if (noAssignment) noAssignment.style.display = 'none';
            if (assignmentInfo) assignmentInfo.style.display = 'block';
            if (assignedProjectName) assignedProjectName.textContent = projectName;
            if (assignedApplicationName) assignedApplicationName.textContent = appName;
            if (assignedApplicationVersion) {
                assignedApplicationVersion.textContent = appVersion ? ` (${appVersion})` : '';
            }
            
            closeProjectAssignmentModal();
        }
        
        function clearProjectAssignment() {
            const hiddenInput = document.getElementById('applicationId');
            if (hiddenInput) {
                hiddenInput.value = '';
            }
            
            const noAssignment = document.getElementById('noAssignment');
            const assignmentInfo = document.getElementById('assignmentInfo');
            
            if (noAssignment) noAssignment.style.display = 'block';
            if (assignmentInfo) assignmentInfo.style.display = 'none';
        }
        
        window.openProjectAssignmentModal = openProjectAssignmentModal;
        window.closeProjectAssignmentModal = closeProjectAssignmentModal;
        window.selectApplication = selectApplication;
        window.clearProjectAssignment = clearProjectAssignment;
        
        // Ensure all global functions are available
        if (typeof clearForm === 'function') {
            window.clearForm = clearForm;
        }
        if (typeof saveRequest === 'function') {
            window.saveRequest = saveRequest;
        }
        if (typeof addHeaderRow === 'function') {
            window.addHeaderRow = addHeaderRow;
        }
        if (typeof removeHeader === 'function') {
            window.removeHeader = removeHeader;
        }
        if (typeof validateBody === 'function') {
            window.validateBody = validateBody;
        }
        if (typeof formatBody === 'function') {
            window.formatBody = formatBody;
        }
        if (typeof copyResponse === 'function') {
            window.copyResponse = copyResponse;
        }
        if (typeof loadSavedRequestFromSidebar === 'function') {
            window.loadSavedRequestFromSidebar = loadSavedRequestFromSidebar;
        }
    </script>
    <script src="/dialog.js"></script>
    <script src="/json-formatter.js"></script>
</body>
</html>
